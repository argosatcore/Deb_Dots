webpackJsonp([21],{2506:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),i(2507),i(2511),i(2513),i(2515),i(2517)},2507:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s=i(2508),n=i(2509),r=i(2510),o=function(){function e(e,t,i,s,n,r,o,a,l,c,d,h,p,u,v,f,m){var g=this;if(this.constants=i,this.layoutService=s,this.utilityService=r,this.loggingService=o,this.messageService=a,this.filesMessagePaneHelper=l,this.authenticationService=c,this.filesEntityService=d,this.storageService=p,this.filesUtilityService=u,this.channelService=v,this.settingsService=f,this.showStartConversationButton=!1,this.panelRegions=teamspace.PanelRegion,this.moreOptionsText=e.instant(n.strings.files_moreOptions),this.startConversationClicked=!1,this.theme=f.getActiveTheme(),m.$on(t,i.events.layout.themeChanged,function(){g.theme=f.getActiveTheme()}),this.provider){if(this.provider.iconsService){var w=this.provider.iconsService.getIcon(this.fileType);w&&(this.fileIconPath=w.largeIconPath||w.defaultIconPath,this.isSvgIcon=w.isSvg,this.iconAltTextKey=w.altTextResourceKey)}h.getEntryBreadcrumbInfo(this.provider).then(function(e){g.thumbnailImgSrc=e.thumbnailImgSrc})}this.fileIconPath||(this.fileIconPath=this.getTypeSvgSrc(),this.isSvgIcon=!0),this.initConversation(),t.$on("$destroy",function(){l&&l.destroyContextMessagePane()}),this.trackData={fileId:this.fileId,fileType:this.fileType,error:this.error,errorReasonForTelemetry:this.errorReasonForTelemetry}}return e.$inject=["$translate","$scope","constants","layoutService","resources","utilityService","loggingService","messageService","filesMessagePaneHelper","authenticationService","filesEntityService","filesNavigationEntryService","storageService","filesUtilityService","channelService","settingsService","eventingService"],e.prototype.$onChanges=function(e){if(this.hasPrimaryOptions=this.primaryOptions&&this.primaryOptions.options&&this.primaryOptions.options.length&&this.primaryOptions.options.some(function(e){return!e.shouldBeHidden()}),this.settingsService.valueAsBoolean(this.constants.settings.names.enableTeamArchive)&&this.conversationInfo&&this.conversationInfo.threadId){var t=this.channelService.getParentTeamAndChannelByChannelId(this.conversationInfo.threadId);this.isTeamArchived=t&&t.team&&t.team.isArchived}this.isEditButtonAvailable=!!this.hasPrimaryOptions||this.filesUtilityService.isVisioDesktopAppOnlyEditEnabled(this.fileType)||this.moveEditInBrowserFromMoreOptions,this.hasMoreOptions=this.moreOptions&&this.moreOptions.length&&this.moreOptions.some(function(e){return!e.shouldBeHidden()}),e.error&&e.error.previousValue!==e.error.currentValue&&void 0!==e.error.currentValue&&this.initConversation(),e.displayTitleBar&&!1===e.displayTitleBar.previousValue&&!0===e.displayTitleBar.currentValue&&this.initConversation()},e.prototype.initConversation=function(){var e=this;if(this.filesMessagePaneHelper&&this._conversationInfo&&this._conversationInfo.threadId&&this.viewerType&&void 0!=this.displayTitleBar){var t=this.displayTitleBar||void 0!==this.error,i=/p2p/i.test(this._conversationInfo.serviceName);this.filesMessagePaneHelper.initializeContextMessagePane(this._conversationInfo.objectId,this._conversationInfo.threadId,this.viewerType,i,void 0,t).then(function(t){return e.updateEnablePostToChannel(t,i)})}},e.prototype.updateEnablePostToChannel=function(e,t){this.showStartConversationButton=e&&!t?!!this.channelService.canPostToChannel(this.conversationInfo.threadId)&&e:e},Object.defineProperty(e.prototype,"conversationInfo",{get:function(){return this._conversationInfo},set:function(e){this._conversationInfo||(this._conversationInfo=e,this.initConversation())},enumerable:!0,configurable:!0}),e.prototype.getTypeSvgSrc=function(){void 0===this.fileType&&(this.loggingService.warn("[getTypeSvgSrc] FileType is undefined, setting to empty string to get default svg"),this.fileType="");var e=this.utilityService.getIconClass({type:this.fileType}),t=this.constants.css.fileIcons;return[t.excel,t.onenote,t.pdf,t.powerpoint,t.visio,t.word].includes(e)?"svg/"+this.utilityService.getSVGBase(this.fileType,"icons-{type}-file-32_1.5x")+".html":"svg/"+this.utilityService.getSVGBase(this.fileType,"icons-{type}")+".html"},e.prototype.startConversation=function(){var e=this;if(!this.startConversationClicked){this.startConversationClicked=!0;var t=this.loggingService.newScenario(this.constants.scenarios.files.toggleChatOpened);this.filesMessagePaneHelper.getReplyChainIdFromFileId(this._conversationInfo.objectId,this._conversationInfo.threadId).then(function(i){i?(e.storageService.set(""+e.constants.files.strings.saveChatIsExpanded,!0),e.filesMessagePaneHelper.showRightRail(e._conversationInfo.threadId,i,teamspace.services.ReplyChainIdType.ParentMessageId,/p2p/i.test(e._conversationInfo.serviceName)),e.showStartConversationButton=!1,t.stop()):(e.createFileAttachment?e.createFileAttachment():e.filesEntityService.getFileDetail(e.fileType,e.conversationInfo.objectUrl).then(function(e){return e.value}).then(function(t){return e.getAttachment(t)})).then(function(t){var i=e.getMessageParams(t,e.conversationInfo.threadId);return e.messageService.createMessage(i)}).then(function(t){return e.authenticationService.getUserInformation().then(function(e){return{upn:((e||{}).profile||{}).upn,messageId:t.messageId}})}).then(function(t){return t.upn?e.storageService.set(""+e.constants.files.strings.saveChatIsExpanded,!0):e.loggingService.warn("Failed to resolve user upn on start conversation"),t.messageId?e.storageService.set(""+e.constants.files.strings.saveChatIsExpanded,!0):e.loggingService.warn("Failed to resolve messageId on start conversation"),t.messageId}).then(function(t){return e.filesMessagePaneHelper.initializeContextMessagePane(e.conversationInfo.objectId,e.conversationInfo.threadId,e.viewerType,!1,t)}).then(function(){return e.showStartConversationButton=!1}).then(function(){return t.stop()}).catch(function(i){var s="Failed to start conversation";e.startConversationClicked=!1,e.loggingService.error(s),t.fail({error:s})})})}},e.prototype.rightRailShowExistingComponent=function(){var e=this.loggingService.newScenario(this.constants.scenarios.files.toggleChatOpened);this.layoutService.rightRailShowExistingComponent(),e.stop()},e.prototype.getAttachment=function(e){return{objectId:e.objectId,objectUrl:e.objectUrl,siteUrl:e.siteUrl,serverRelativeUrl:e.serverRelativeUrl,title:e.title,type:e.type}},e.prototype.getMessageParams=function(e,t){return{conversationId:t,replyChainId:"",messageSubject:"",messageBody:"",messagePreview:"",fileAttachments:[e],extensions:"",mentions:"",embeddedLinks:[],isHtml:!0,importance:null,clientId:SkypeX.Services.Utilities.newClientMessageId(),draftObjectId:""}},e}();angular.module("teamspace.fileDocumentTitleBar",["teamspace.layoutService","teamspace.utilityService","teamspace.loggingService","teamspace.messageService","teamspace.settingsService","teamspace.filesEntityService","teamspace.authenticationService","teamspace.filesMessagePaneHelper"]).component("fileDocumentTitleBar",{bindings:{isEditMode:"<?",displayTitleBar:"<?",editAction:"<?",fileName:"<",fileType:"<",fileId:"<",viewerType:"<",hideClose:"<?",onClose:"&?",isEnabled:"=",inlineActions:"<?",primaryOptions:"<?",moreOptions:"<?",conversationInfo:"<?",createFileAttachment:"&?",provider:"<?",error:"<?",errorReasonForTelemetry:"<?",moveEditInBrowserFromMoreOptions:"<?"},template:s,controller:o}).run(["$templateCache",function(e){e.put("components/files/document-viewer/file-document-title-bar/file-document-title-bar-options.html",n),e.put("components/files/document-viewer/file-document-title-bar/file-document-title-bar-more-options.html",r)}])},2508:function(e,t){e.exports='<div class="app-title-bar" analytics-panel="{{::$ctrl.panelRegions.main}}" analytics-panel-view="{ panel: {type: {{$root.trackConstants.panelType.documentStage}} }}" track-data="{{::$ctrl.trackData}}">\n  <svg-include class="title-component title-visible svg-icon" ng-if="$ctrl.isSvgIcon" src="::$ctrl.fileIconPath"></svg-include>\n  <div class="title-component title-visible img-icon" ng-if="!$ctrl.isSvgIcon">\n    <img ng-src="{{::$ctrl.fileIconPath}}" alt="{{::$ctrl.iconAltTextKey|translate}}" title="{{::$ctrl.iconAltTextKey|translate}}"/>\n  </div>\n  <h1 class="title-component title-visible" data-tid="document-stage-title-bar">\n    <span class="document-title" tabindex="0" role="heading">{{::$ctrl.fileName}}</span>\n  </h1>\n  \x3c!--\n    TODO: Requirement 437506\n      <span class="save-status" id="file-save-status"></span>\n  --\x3e\n</div>\n<div class="right-side-buttons pull-right">\n  <div ng-if="::$ctrl.thumbnailImgSrc" class="provider-icon">\n    <span class="app-svg img-container">\n      <img ng-src="{{::$ctrl.thumbnailImgSrc}}"/>\n    </span>\n  </div>\n  <div ng-if="$ctrl.inlineActions && $ctrl.inlineActions.length">\n    <button class="ts-sym inline-action" type="button" ng-repeat="menuItem in $ctrl.inlineActions track by $index" ng-if="!(menuItem.shouldBeHidden && menuItem.shouldBeHidden())" ng-click="menuItem.click()" ng-disabled="!$ctrl.isEnabled" aria-label="{{menuItem.title || menuItem.displayName || undefined}}" ng-attr-title="{{menuItem.title || undefined}}">\n      <svg-include src="menuItem.svgPath"></svg-include>\n      <span>{{menuItem.displayName}}</span>\n    </button>\n  </div>\n  <div class="btn-edit btn-group" ng-if="$ctrl.isEditButtonAvailable && !$ctrl.isEditMode && $ctrl.editAction">\n      <button class="btn ts-btn ts-btn-fluent ts-btn-fluent-titlebar" ng-class="($ctrl.theme==\'contrast\') ? \'ts-btn-fluent-secondary\' : \'ts-btn-fluent-primary\'" aria-label="{{::$ctrl.primaryOptions.primaryButtonAria}}" type="button" ng-click="$ctrl.editAction()" ng-disabled="!$ctrl.isEnabled || $ctrl.isTeamArchived" data-tid="title-bar-primary-edit-button">\n        <span class="ts-btn-edit-text">{{::$ctrl.primaryOptions.primaryButtonText}}</span>\n      </button>\n      <div ng-if="::$ctrl.hasPrimaryOptions" class="dropdown-separator"></div>\n      <button ng-if="::$ctrl.hasPrimaryOptions" aria-label="{{::$ctrl.primaryOptions.dropdownButtonText}}" class="btn ts-btn ts-btn-fluent tn-btn-titlebar inset-border dropdown-toggle-split" ng-class="($ctrl.theme==\'contrast\') ? \'ts-btn-fluent-secondary\' : \'ts-btn-fluent-primary\'" ng-disabled="!$ctrl.isEnabled || $ctrl.isTeamArchived" bs-dropdown placement="bottom" container="body" data-template-url="components/files/document-viewer/file-document-title-bar/file-document-title-bar-options.html" data-tid="title-bar-dropdown-edit-button">\n        <svg-include src="\'svg/icons-triangle-down-small.html\'"></svg-include>\n      </button>\n  </div>\n    <button class="ts-btn ts-btn-fluent ts-btn-fluent-titlebar" ng-class="($ctrl.theme==\'contrast\') ? \'ts-btn-fluent-secondary\' : \'ts-btn-fluent-primary\'" ng-if="::$ctrl.hasPrimaryOptions && !$ctrl.editAction" type="button" ng-disabled="!$ctrl.isEnabled" bs-dropdown placement="bottom" container="body" data-template-url="components/files/document-viewer/file-document-title-bar/file-document-title-bar-options.html" data-tid="title-bar-edit-button">\n      <span class="ts-btn-edit-text">{{::$ctrl.primaryOptions.primaryButtonText}}</span>\n      <ng-include src="\'svg/icons-triangle-down-small.html\'"></ng-include>\n    </button>\n    <button ng-show="$ctrl.showStartConversationButton" class="ts-btn ts-btn-fluent ts-btn-fluent-secondary ts-btn-fluent-titlebar" type="button" ng-click="$ctrl.startConversation()" translate-once="{{::$root.resources.strings.files_startConversation }}" track-outcome="{{::$root.trackConstants.trackOutcome.submit}}" track-scenario="{{::$root.trackConstants.trackScenario.fileStartConversation}}" track-scenario-type="{{::$root.trackConstants.trackScenarioType.files}}" track-name="{{::$root.trackConstants.trackModuleName.documentStageStartConversationButton}}" track-type="{{::$root.trackConstants.trackType.submit}}" track-summary="Starts a conversation around the file and opens the chat pane" data-tid="start-conversation" ng-disabled="!$ctrl.isEnabled">\n    </button>\n    <button class="ts-btn ts-btn-fluent ts-btn-fluent-secondary btn-close ts-btn-fluent-titlebar" ng-if="$ctrl.onClose && !$ctrl.hideClose" type="button" ng-click="$ctrl.onClose()" track-outcome="{{::$root.trackConstants.trackOutcome.nav}}" track-scenario="{{::$root.trackConstants.trackScenario.closeDocumentStage}}" track-scenario-type="{{::$root.trackConstants.trackScenarioType.files}}" track-name="{{::$root.trackConstants.trackModuleName.documentStageCloseButton}}" track-type="{{::$root.trackConstants.trackType.other}}" track-summary="Close the document stage" aria-label="{{::$root.resources.strings.files_closeDocumentStageAria | translate }}" translate-once="{{::$root.resources.strings.files_closeFullscreenButton }}" data-tid="fullscreen-close-button">\n    </button>\n</div>\n<span ng-if="!$ctrl.hasMoreOptions" class="right-padding"></span>\n<div ng-if="$ctrl.hasMoreOptions" class="inline-button pull-right">\n  <button class="ts-sym app-icons-fill-hover" title="{{::$ctrl.moreOptionsText}}" aria-label="{{::$ctrl.moreOptionsText}}" type="button" ng-disabled="!$ctrl.isEnabled" bs-dropdown placement="bottom" container="body" data-template-url="components/files/document-viewer/file-document-title-bar/file-document-title-bar-more-options.html" data-tid="title-bar-more-button" aria-haspopup="true">\n    <ng-include src="\'svg/icons-more.html\'"></ng-include>\n  </button>\n</div>\n<div class="inline-button pull-right collapsable" ng-class="{\'expand\': $ctrl.layoutService.rightRailVisible || !$ctrl.layoutService.rightRailContext}">\n  <button ng-disabled="!$ctrl.isEnabled" type="button" ng-if="!$ctrl.layoutService.rightRailVisible && $ctrl.layoutService.rightRailContext" class="ts-sym app-icons-fill-hover pull-right" ng-click="$ctrl.rightRailShowExistingComponent()" track-outcome="{{::$root.trackConstants.trackOutcome.submit}}" track-scenario="{{::$root.trackConstants.trackScenario.fileStartConversation}}" track-scenario-type="{{::$root.trackConstants.trackScenarioType.files}}" track-name="{{::$root.trackConstants.trackModuleName.documentStageStartConversationButton}}" track-type="{{::$root.trackConstants.trackType.submit}}" track-summary="Opens the conversation around the file" data-tid="document-chat-expand" title="{{::$root.resources.strings.calling_toggleChat_on|translate}}" aria-label="{{::$root.resources.strings.calling_toggleChat_on|translate}}">\n    <ng-include src="\'svg/icons-chat.html\'"></ng-include>\n  </button>\n</div>\n'},2509:function(e,t){e.exports='<div class="context-dropdown dropdown-menu dropdown app-default-menu files-popover">\n  <ul class="context-menu-dropdown file-action-menu" acc-role="menu">\n    <li ng-repeat="menuItem in $ctrl.primaryOptions.options track by $index" ng-class="::menuItem.class" ng-if="!(menuItem.shouldBeHidden && menuItem.shouldBeHidden())" class="ts-menu-item" acc-role="menu-item focus-default" aria-label="{{ ::menuItem.displayName }}">\n      <button class="ts-sym ts-svg" acc-role="focus-default" ng-click="menuItem.click()" data-tid="{{ menuItem.id }}" type="button" track-outcome="{{::$root.trackConstants.trackOutcome.submit}}" track-scenario="{{menuItem.id == \'office-open-in-desktop-app\' ? $root.trackConstants.trackScenario.editFileInApp : $root.trackConstants.trackScenario.editFileOnline}}" track-scenario-type="{{::$root.trackConstants.trackScenarioType.files}}" track-name="{{::$root.trackConstants.trackModuleName.fileDocumentTitleBar}}" track-type="{{::$root.trackConstants.trackType.menuItem}}" track-data="{fileAction: \'{{::menuItem.id}}\', fileControl: \'file edit menu\', fileId: \'{{::$ctrl.fileId}}\'}" track-summary="Edit a file in app OR edit a file in Office online">\n        <ng-include src="menuItem.svgPath"></ng-include>\n        <span aria-hidden="true">{{menuItem.displayName}}</span>\n      </button>\n    </li>\n  </ul>\n</div>'},2510:function(e,t){e.exports='<div class="context-dropdown dropdown-menu dropdown app-default-menu files-popover">\n  <ul class="context-menu-dropdown file-action-menu" acc-role="menu">\n    <li ng-repeat="menuItem in $ctrl.moreOptions track by $index" ng-if="::!(menuItem.shouldBeHidden && menuItem.shouldBeHidden())" class="ts-menu-item" acc-role="menu-item focus-default" aria-label="{{ ::menuItem.displayName }}">\n      <button class="ts-sym ts-svg" type="button" ng-click="menuItem.click()" data-tid="{{ menuItem.id }}" track-outcome="{{::$root.trackConstants.trackOutcome.select}}" track-scenario="{{::$root.trackConstants.trackScenario.selectFileAction}}" track-scenario-type="{{::$root.trackConstants.trackScenarioType.files}}" track-name="{{::$root.trackConstants.trackModuleName.fileActionButton}}" track-type="{{::$root.trackConstants.trackType.menuItem}}" track-data="{fileAction: \'{{::menuItem.id}}\', fileControl: \'file action menu\', fileId: \'{{::$ctrl.fileId}}\'}" track-summary="Choose a file action to perform - document stage">\n        <ng-include src="menuItem.svgPath"></ng-include>\n        <span aria-hidden="true">{{menuItem.displayName}}</span>\n      </button>\n    </li>\n  </ul>\n</div>'},2511:function(e,t,i){"use strict";var s=this&&this.__assign||function(){return(s=Object.assign||function(e){for(var t,i=1,s=arguments.length;i<s;i++){t=arguments[i];for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])}return e}).apply(this,arguments)};Object.defineProperty(t,"__esModule",{value:!0});var n,r=i(2512),o=i(76);!function(e){e.SameDocument="0",e.NewDocument="1"}(n=t.RebootMode||(t.RebootMode={}));var a=function(){function e(e,t,i,s,n,r,a,l,c,d,h,p,u,v,f,m,g,w,y,S,b,I,C,U,E,T,A,P,$,k,F,D,O,x,N){var B=this;this.$scope=e,this.$q=t,this.resources=s,this.$timeout=r,this.$state=a,this.$window=l,this.$sce=c,this.settingsService=d,this.layoutService=h,this.constants=p,this.loggingService=u,this.utilityService=v,this.filesUtilityService=f,this.authenticationService=m,this.routeUtilityService=g,this.filesDocStageHelperService=w,this.filesMessagePaneHelper=y,this.storageService=S,this.messageService=b,this.routeChangeService=I,this.navigationService=U,this.localizationService=E,this.copyLinkFactory=T,this.filesProviderFactory=A,this.createFileFactory=$,this.personalFilesDetailsService=k,this.filesNotificationService=F,this.filesOpenActionSettingService=D,this.shareDialogFactory=O,this.dialogService=x,this.filesExternalLinksService=N,this.webviewElement=null,this.iframeElement=null,this.isCloseButtonClick=!1,this.canPostConversation=!0,this.isConversationPanelOpen=!1,this.childMessageListner=function(e){if(B.iframeElement=B.iframeElement?B.iframeElement:document.getElementById("file-unified-app-viewer-frame"),B.iframeElement&&e.source===B.iframeElement.contentWindow)return B.commonMessageListner({data:e.data})},this.regionalOSSettingPromise=this.getRegionalOSSetting(),this.messageType=p.messages.types.newConversation,this.canPostConversation=C.canPostToCurrentChannel(),this.filesConversationEmptChatPaneHeader=i.instant(s.strings.files_conversation_empty_chat_pane_header),this.filesConversationEmptChatPaneBody=i.instant(s.strings.files_conversation_empty_chat_pane_body),this.logger=u.newLogger("FileViewer"),this.useWebview=d.valueAsBoolean(p.settings.names.isDesktopApp)&&!!l.electronSafeIpc&&l.desktopSettings.enableTabWebviews;var M,R,W=l.electronSafeIpc,V=this.layout.bind(this),_=!1,L=v.getIconClass({type:this.fileType})===p.css.fileIcons.excel;this.entityContext={id:this.fileId,objectUrl:this.objectUrl,serviceName:this.serviceName,title:this.fileName},this.jsApiHostSessionId=u.sessionId+"-"+this.scenario.id,this.routeDocumentViewerParams=g.getRootRouteParams(),W&&this.useWebview?(L&&this.addZoomEventListenersForDesktopClient(),W.send(p.events.desktopApp.allowWebViewCreate,{enablePreload:!0}),W.once(p.events.desktopApp.webViewCreationEnabled,function(){B.webviewElement=window.document.getElementById("file-unified-app-viewer-webview"),B.webviewElement.setAttribute("webpreferences","nativeWindowOpen=yes"),B.webviewElement.setAttribute("allowpopups",""),B.eventListener=new o.EventListener(B.webviewElement);B.eventListener.addListener("ipc-message",function(e){return B.webviewProcessMessage(e)});B.eventListener.addListener("crashed",function(e){return u.event(p.telemetry.webview.crashed,{errorEvent:JSON.stringify(e)})});B.eventListener.addListener("gpu-crashed",function(e){return u.event(p.telemetry.webview.gpuCrashed,{errorEvent:JSON.stringify(e)})});B.eventListener.addListener("plugin-crashed",function(e){return u.event(p.telemetry.webview.pluginCrashed,{errorEvent:JSON.stringify(e)})});B.eventListener.addListener("did-fail-load",function(e){u.event(p.telemetry.webview.loadFailed,{errorEvent:JSON.stringify({errorCode:e?e.errorCode:null,errorDescription:e?e.errorDescription:null})}),B.logger.error("loading failed - did-fail-load fired")}),B.eventListener.addListener("dom-ready",V),B.eventListener.addListener("load-commit",function(e){e&&e.isMainFrame&&(R=M?(Date.now()-M).toString():""),_=e&&e.url&&e.url.startsWith(B.filesExpBaseUrl)}),B.eventListener.addListener("did-frame-finish-load",function(e){if(_){var t={filesExpFrameLoadTime:M?(Date.now()-M).toString():"",webviewFirstLoadCommitTime:R};B.logger.info("did-frame-finish-load scenario markers for files exp frame {0}",t),B.scenario.mark("files-experience-frame-load-time",t),_=!1}}),l.addEventListener("resize",V),B.init(),M=Date.now()})):(this.init(),this.registerForBaseEvents()),I.registerRouteChangeHandler(p.states.appDocumentViewer,this.routeChangeHandler.bind(this)),e.$on("$destroy",function(){l.removeEventListener("resize",V),l.removeEventListener("message",B.childMessageListner),B.eventListener&&B.eventListener.destroy(),f.isIntegratedUXEnabled(B.fileType)&&w.changeFileNameInTeamsChromeHeader(!1),y&&y.destroyContextMessagePane(),I.unregisterRouteChangeHandler(p.states.appDocumentViewer),B.isWACAppCreateNewDocumentScenarioEnabled()&&P.unregister(B.listenerRegistration),L&&B.removeZoomEventListenersForDesktopClient()}),this.isWACAppCreateNewDocumentScenarioEnabled()&&(this.listenerRegistration=P.register(this,e))}return e.$inject=["$scope","$q","$translate","resources","$rootScope","$timeout","$state","$window","$sce","settingsService","layoutService","constants","loggingService","utilityService","filesUtilityService","authenticationService","routeUtilityService","filesDocStageHelperService","filesMessagePaneHelper","storageService","messageService","routeChangeService","channelService","navigationService","localizationService","copyLinkFactory","filesProviderFactory","sharePointStore","createFileFactory","personalFilesDetailsService","filesNotificationService","filesOpenActionSettingService","shareDialogFactory","dialogService","filesExternalLinksService"],e.prototype.addZoomEventListenersForDesktopClient=function(){var e=this.$window.electronSafeIpc;e&&this.useWebview&&(e.send(this.constants.events.desktopApp.autoZoomingEnabled,!1),this.logger.info("addZoomEventListeners called"))},e.prototype.removeZoomEventListenersForDesktopClient=function(){var e=this.$window.electronSafeIpc;e&&this.useWebview&&(e.send(this.constants.events.desktopApp.autoZoomingEnabled,!0),this.logger.info("removeZoomEventListeners called"))},e.prototype.routeChangeHandler=function(e,t,i,s){var n=this;if(s.name===this.constants.states.appDocumentViewer&&!e.defaultPrevented){this.dialogService.close();var r=!0===this.isCloseButtonClick?this.settingsService.valueFor(this.constants.settings.names.closeDocStagePromiseTimeout):this.settingsService.valueFor(this.constants.settings.names.navigationDocStagePromiseTimeout);this.logger.info("unloading timeout {0}",r);var o=function(){n.logger.info("navigating away from doc-stage on timeout "+r),n.routeChangeService.unregisterRouteChangeHandler(n.constants.states.appDocumentViewer),n.$state.go(t,i)};if(0==r)return void o();this.toStateForUnloading=t,this.toStateParamsForUnloading=i,this.unlockFilePromise=this.filesDocStageHelperService.unlockFile(r).finally(function(){return o()}),e.preventDefault()}},e.prototype.registerForBaseEvents=function(){this.$window.addEventListener("message",this.childMessageListner)},e.prototype.commonMessageListner=function(e){switch(e.data.channel){case"multi-window-manager-channel":return this.handlePostMessagesEvents(e.data.payload)}},e.prototype.handlePostMessagesEvents=function(e){var t=this;switch(this.logger.info("Post message received for event {0}",e.eventId),e.eventId){case teamspace.services.ChildWindowEventRequest.WindowReady:this.logger.info("Child frame has reported ready state");break;case teamspace.services.ChildWindowEventRequest.WindowInitialized:this.logger.info("Child frame has reported it is fully initialized");break;case teamspace.services.ChildWindowEventRequest.NewWindow:this.logger.info("Child frame requested to open new window directly (blocked)");break;case teamspace.services.ChildWindowEventRequest.AadGetToken:var i=e.eventId;if(e.correlationId&&e.payload){n=e.payload.resource;return this.filesUtilityService.updateTokenWarmingRule(n),this.logger.info("Child frame requested AAD token: resource={0}, correlationId={1}",n,e.correlationId),this.authenticationService.getAuthTokens([n]).then(function(s){var n={eventId:i,correlationId:e.correlationId,payload:{token:s}};t.filesDocStageHelperService.sendPostMessage(n,t.iframeElement,t.webviewElement)}).catch(function(i){t.logger.error("ERROR: failed to get auth token: correlationId={0}, error={1}",e.correlationId,i)})}this.logger.error("Expected payload or correlationId for {0} but got none",i);break;case teamspace.services.ChildWindowEventRequest.AadGetCurrentUser:if(e.correlationId)return this.logger.info("Child frame requested current logged in user correlationId={0}",e.correlationId),this.authenticationService.getUserInformation().then(function(i){var s={eventId:e.eventId,correlationId:e.correlationId,payload:{authUser:i}};t.filesDocStageHelperService.sendPostMessage(s,t.iframeElement,t.webviewElement)}).catch(function(i){t.logger.error("ERROR: failed to get current logged in user correlationId={0}, error={1}",e.correlationId,i)});this.logger.error("ERROR: AadGetCurrentUser request was made but no correlationId was given");break;case teamspace.services.ChildWindowEventRequest.AadClearCache:if(e.payload){var n=e.payload.resource;this.logger.info("Child frame requested clear adal cache:  resource={0}, correlationId={1}",n,e.correlationId),n&&this.authenticationService.clearAdalCache(n)}else this.logger.error("Expected data for event {0} but got none",e.event);break;case teamspace.services.ChildWindowEventRequest.HideFileViewerLoader:this.hideSpinner();break;case teamspace.services.ChildWindowEventRequest.StopDocStageScenario:e.payload&&this.handleScenario(e.payload);break;case teamspace.services.ChildWindowEventRequest.GetDriveItemResponse:y=e.payload&&e.payload.sendTime&&Date.now()-e.payload.sendTime;return this.scenario.mark("exp-request-drive-item",{ipcTimeOverhead:y}),this.$q.all([this.redeemPromise,this.regionalOSSettingPromise]).then(function(i){var n=i[0],r=i[1],o=n.sensitivityLabel&&n.sensitivityLabel.protectionEnabled;t.scenario.mark("redeem-post-success");var a=s(s({},n),{driveItemCallStartTime:t.driveItemCallStartTime,driveItemCallEndTime:Date.now(),localeFromOS:r,fileActions:t.filesUtilityService.isIntegratedUXEnabled(t.fileType)?t.filesDocStageHelperService.getFileActions(n,t.hideClose,t.fileType):null,flights:t.getFileScenarioFlights(),sessionOrigin:t.getWacSessionOrigin(),navId:t.routeDocumentViewerParams.navId,templateId:t.settingsService.valueAsBoolean(t.constants.settings.names.enableWACCreateNewTemplateDocument)?t.routeDocumentViewerParams.templateId:void 0,userClickTime:t.userClickTime,file:s(s({},n.file),{irmEnabled:o})});t.isWACAppDocRebootScenarioEnabled()&&(a.rebootOverrideData=t.routeDocumentViewerParams.rebootOverrideData);var l={eventId:e.eventId,correlationId:e.correlationId,payload:a};t.logger.info("sending redeem response to Files experience"),t.filesDocStageHelperService.sendPostMessage(l,t.iframeElement,t.webviewElement);var c=t.utilityService.getIconClass({type:t.fileType})===t.constants.css.fileIcons.word,d=n.currentUserRole&&n.currentUserRole.readOnly;t.fileName!=n.name&&(t.fileName=n.name),(d&&!t.isWordRibbonInReadOnlyModeEnabled()||o)&&c?t.moveEditInBrowserFromMoreOptions||(t.displayTitleBar=!0,t.isEditMode=!0):t.filesUtilityService.isIntegratedUXEnabled(t.fileType)&&!1===t.displayTitleBar&&t.filesDocStageHelperService.changeFileNameInTeamsChromeHeader(!0,t.fileName)});case teamspace.services.ChildWindowEventRequest.AddScenarioMarker:e.payload&&this.addScenarioMarker(e.payload);break;case teamspace.services.ChildWindowEventRequest.FilesExperienceSendData:switch(this.logger.info("Post message received with messageId {0}",e.payload.MessageId),e.payload.MessageId){case"App_AccessibilityLoopComplete":var r="backward"!==e.payload.Values.Direction;this.layoutService.navigateToNextLandmark(r);break;case"Wac_ActionComplete":this.logger.info("wac action completed {0} ",e.payload);var o=e.payload.Values&&e.payload.Values.Action,a=e.payload.Values&&e.payload.Values.wdUserSession;if(!o)return void this.logger.info("unknown action reported from WAC");if("OpenInBrowser"===o)return void this.findAndPerformActionButtonClick("office-open-in-new-tab",a);"OpenInDesktop"===o&&this.filesDocStageHelperService.logAction("Open_In_Desktop",this.fileId,this.fileType);var l=e.payload.sendTime,c=e.payload.SendTime,d=c&&l?(l-c).toString():"",h=l?(Date.now()-l).toString():"",p=c?(Date.now()-c).toString():"",u=e.payload.Values&&e.payload.Values.wdUserSession,v=this.constants.scenarios.files.openOfficeFileInDesktop,f=this.loggingService.newScenario(v);f.eventData.entryPoint=this.serviceName,f.eventData.context=this.ctx||this.utilityService.getUrlRootContext(),f.eventData.type=this.fileType,f.eventData.viewerType=teamspace.services.files.modules.sharePoint.FilePreviewerTypes.UnifiedApp,f.stop({ipcOverheadToExperienceFromWac:d,ipcOverheadToMainAppFromExperience:h,ipcOverHead:p,wdUserSession:u,jsApiHostSessionId:this.jsApiHostSessionId});break;case"Action_Button_Click":var m=e.payload&&e.payload.SendTime,g={ipcOverheadToExperienceFromWac:m&&e.payload.receivedTime?(e.payload.receivedTime-m).toString():"",ipcOverheadToMainAppFromExperience:e.payload.receivedTime?(Date.now()-e.payload.receivedTime).toString():"",ipcOverHead:m&&(Date.now()-m).toString(),ipcCorrelationId:e.payload.CorrelationId,ipcwdUserSession:e.payload.wdUserSession,jsApiHostSessionId:this.jsApiHostSessionId};this.logger.info("wdUserSession {0} correlationId {1} hostSessionId {2}",e.payload.wdUserSession,e.payload.CorrelationId,this.jsApiHostSessionId);var w=this.constants.scenarios.files.actionButton+"_"+e.payload.button;this.loggingService.newScenario(w).stop(g),this.handleActionButtonsClick(e.payload),this.filesDocStageHelperService.logAction(e.payload.button,this.fileId,this.fileType);break;case"Unload":var y=e.payload.sendTime&&Date.now()-e.payload.sendTime;this.$timeout.cancel(this.unlockFilePromise),this.closeFileUnlockScenario(y),this.routeChangeService.unregisterRouteChangeHandler(this.constants.states.appDocumentViewer),this.$state.go(this.toStateForUnloading,this.toStateParamsForUnloading);break;case"Reboot":this.rebootFile(e.payload);break;case"File_Renamed":if(this.settingsService.valueAsBoolean(this.constants.settings.names.enableWACFileRenameScenario)&&e.payload.NewName){var S=e.payload.NewName+"."+this.fileType;S!==this.fileName&&(this.fileName=S,this.$scope.$apply(function(){t.filesDocStageHelperService.changeFileNameInTeamsChromeHeader(!0,t.fileName)}))}break;case"Error":this.logger.error("ErrorMessage: "+e.payload.errorMessage),this.handleErrorFromNStarExperience(e.payload);break;case"App_SwitchMode":this.handleModeSwitch(e.payload);break;case"Get_ReplyChainId":var b=void 0,I=this.routeDocumentViewerParams.messageId;I?b=this.$q.resolve(I):(this.replyChainIdPromise||(this.replyChainIdPromise=this.filesMessagePaneHelper.getReplyChainIdFromFileId(this.fileId,this.threadId)),b=this.replyChainIdPromise),b.then(function(i){var s={eventId:teamspace.services.ChildWindowEventRequest.FilesExperienceSendData,correlationId:e.correlationId,payload:{replyChainId:i,threadId:t.threadId}};t.filesDocStageHelperService.sendPostMessage(s,t.iframeElement,t.webviewElement)});break;case"Open_File":this.gotoSPOFile(e.payload);break;case"App_CreateNewDocument":this.createNewFile(e.payload);break;case"App_WopiInfoFromUrl":this.settingsService.valueAsBoolean(this.constants.settings.names.enableExternalLinkScenario)&&this.filesExternalLinksService.handleWopiInfo(e.payload)}break;default:this.logger.info("Child frame has reported event {0} which doesn't exist {1}",e.eventId,e)}},e.prototype.getRegionalOSSetting=function(){var e=this,t=this.$q.defer(),i=this.settingsService.valueAsBoolean(this.constants.settings.names.enableRegionalSettingFromOS),s=this.utilityService.getIconClass({type:this.fileType})===this.constants.css.fileIcons.excel;return i&&s&&this.$window.getLocaleInfoAsync?(this.scenario.mark("get-regional-setting-call-start"),this.$window.getLocaleInfoAsync().then(function(i){e.scenario.mark("get-regional-setting-call-end"),t.resolve(i&&i.regionalFormat)}).catch(function(i){e.scenario.mark("get-regional-setting-call-failed",{reason:JSON.stringify(i)}),t.resolve(void 0)})):t.resolve(void 0),t.promise},e.prototype.isWACAppDocRebootScenarioEnabled=function(){return this.settingsService.valueAsBoolean(this.constants.settings.names.enableWACAppDocRebootScenario)},e.prototype.getFileScenarioFlights=function(){return{enableWACAppCreateNewDocumentScenario:this.isWACAppCreateNewDocumentScenarioEnabled(),enableWACAppDocRebootScenario:this.isWACAppDocRebootScenarioEnabled(),enableWordRibboninReadMode:this.isWordRibbonInReadOnlyModeEnabled(),enableWACAppModeSwitch:this.settingsService.valueAsBoolean(this.constants.settings.names.enableWACAppModeSwitch),enablePassingDynamicThrottlingSignalToWAC:this.settingsService.valueAsBoolean(this.constants.settings.names.enablePassingDynamicThrottlingSignalToWAC),enableWACCopyLinkScenario:this.settingsService.valueAsBoolean(this.constants.settings.names.enableWACCopyLinkScenario),hideWACOneDriveFileLocationPicker:this.hideWACOneDriveFileLocationPickerButton(),enableWACUserAccessScenario:this.settingsService.valueAsBoolean(this.constants.settings.names.enableWACUserAccessScenario),enableWACFileRenameScenario:this.settingsService.valueAsBoolean(this.constants.settings.names.enableWACFileRenameScenario),enableFilesNotifications:this.settingsService.valueAsBoolean(this.constants.settings.names.enableFilesNotifications),enableFileOpenExperiment:this.settingsService.valueAsBoolean(this.constants.settings.names.enableFileOpenExperiment),enableWebAsDefaultFileOpenPreference:this.settingsService.valueAsBoolean(this.constants.settings.names.enableWebAsDefaultFileOpenPreference),enableFileClickOpeningInWeb:this.settingsService.valueAsBoolean(this.constants.settings.names.enableFileClickOpeningInWeb),enableExternalLinkScenario:this.settingsService.valueAsBoolean(this.constants.settings.names.enableExternalLinkScenario)}},e.prototype.hideWACOneDriveFileLocationPickerButton=function(){return this.settingsService.valueAsBoolean(this.constants.settings.names.hideWACOneDriveFileLocationPicker)&&this.useWebview},e.prototype.isWordRibbonInReadOnlyModeEnabled=function(){return this.utilityService.getIconClass({type:this.fileType})===this.constants.css.fileIcons.word&&this.settingsService.valueAsBoolean(this.constants.settings.names.enableWordRibboninReadMode)},e.prototype.isWXPExtension=function(e){var t=this.utilityService.getIconClass({type:e});return t===this.constants.css.fileIcons.word||t===this.constants.css.fileIcons.powerpoint||t===this.constants.css.fileIcons.excel},e.prototype.onStateChanged=function(e){this.isWACAppCreateNewDocumentScenarioEnabled()&&(e.createErrorData?e.createErrorData.errorCode===this.constants.files.error.filenameCollision&&(this.filesNotificationService.showFailureNotification(this.resources.strings.files_fileRenameConflictError),this.logger.info("File name collision")):e.viewerRoute&&e.createdEntityWacUrl&&(e.viewerRoute.documentViewerParams.wacScenario=this.constants.wacScenario.createNewDoc,this.filesUtilityService.navigateToNewFile(e)))},e.prototype.gotoSPOFile=function(e){var t=e.serviceName?e.serviceName:this.constants.files.serviceName.teams,i={documentViewerParams:{fileType:e.fileType,serviceName:t,objectUrl:e.objectUrl,threadId:e.threadId,messageId:e.messageId,baseUrl:e.baseUrl,fileId:e.fileId,viewerAction:this.constants.files.fileActions.viewer.view},viewerState:this.constants.states.appDocumentViewer};return this.navigationService.navigateToFileViewer(i)},e.prototype.handleErrorFromNStarExperience=function(e){this.hideSpinner(),this.handleScenario(s({status:!1},e)),this.displayTitleBar=!0,this.fileErrorCode=this.constants.files.error.unknown+"_unifiedapp",this.allowDownloadOnError=e.allowDownload},e.prototype.handleActionButtonsClick=function(e){switch(e.button){case"Conversation":this.layoutService.rightRailVisible?this.layoutService.rightRailHide():this.isConversationPanelOpen?this.isConversationPanelOpen=!1:this.setUpConversationPane();break;case"Close":this.isCloseButtonClick=!0,this.onClose();break;case"Open_In_Desktop":this.findAndPerformActionButtonClick("office-open-in-desktop-app");break;case"Open_In_Browser":this.findAndPerformActionButtonClick("office-open-in-new-tab",e.wdUserSession);break;case"Download":this.findAndPerformActionButtonClick("download-office-document");break;case"Share":this.settingsService.valueAsBoolean(this.constants.settings.names.enableWACCopyLinkScenario)&&this.handleCopyLink(e);break;case"CheckUserAccessAndGrantPermissions":this.settingsService.valueAsBoolean(this.constants.settings.names.enableWACUserAccessScenario)&&this.showOdspShareDialog(e,this.constants.files.odspShareDialog.dialogMode.userAccess)}},e.prototype.findAndPerformActionButtonClick=function(e,t){var i=this.moreOptions.filter(function(t){return t.id===e})[0];t?i.click(void 0,void 0,void 0,void 0,t):i.click()},e.prototype.initiateConversation=function(e){var t=this,i=this.loggingService.newScenario(this.constants.scenarios.files.toggleChatOpened);this.redeemPromise.then(function(e){var i=e,s=i.webDavUrl,n=i.name,r=i.sharepointIds,o=r.siteUrl,a=r.listItemUniqueId;return{serverRelativeUrl:t.filesUtilityService.extractServerRelativeUrl(s),siteUrl:o,objectUrl:s,objectId:a,title:n,type:t.fileType}}).then(function(s){var n=t.createMessageWithCurrentFile(e,s);return n.scenario=i,t.messageService.createMessage(n)}).then(function(e){t.isConversationPanelOpen=!1,t.storageService.set(""+t.constants.files.strings.saveChatIsExpanded,!0),t.filesMessagePaneHelper.initializeContextMessagePane(t.fileId,t.threadId,teamspace.services.files.modules.sharePoint.FilePreviewerTypes.UnifiedApp,!1,e.messageId),t.replyChainIdPromise=null}).then(function(){return i.stop()}).catch(function(e){var s="Failed to start conversation";t.loggingService.error(s),i.fail({error:s})})},e.prototype.createMessageWithCurrentFile=function(e,t){var i={conversationId:this.threadId,replyChainId:"",messageSubject:e?e.subject:"",messageBody:e?e.message:"",messagePreview:e?e.preview:"",fileAttachments:e?e.attachments:[],extensions:e?e.extensions:"",mentions:e?e.mentions:"",embeddedLinks:e?e.embeddedlinks:[],isHtml:!0,importance:e?e.importance:null,clientId:SkypeX.Services.Utilities.newClientMessageId(),draftObjectId:e?e.draftObjectId:""};return i.fileAttachments.push(t),i},e.prototype.setUpConversationPane=function(){var e=this,t=this.loggingService.newScenario(this.constants.scenarios.files.toggleChatOpened),i=/p2p/i.test(this.serviceName);if(i)return this.storageService.set(""+this.constants.files.strings.saveChatIsExpanded,!0),this.filesMessagePaneHelper.showRightRail(this.threadId,void 0,teamspace.services.ReplyChainIdType.MessageId,i),void t.stop();this.replyChainIdPromise||(this.replyChainIdPromise=this.filesMessagePaneHelper.getReplyChainIdFromFileId(this.fileId,this.threadId)),this.replyChainIdPromise.then(function(s){s?(e.storageService.set(""+e.constants.files.strings.saveChatIsExpanded,!0),e.filesMessagePaneHelper.showRightRail(e.threadId,s,teamspace.services.ReplyChainIdType.ParentMessageId,i),t.stop()):e.isConversationPanelOpen=!0}).catch(function(){e.replyChainIdPromise=null;var i="Failed to get reply chain";e.loggingService.error(i),t.fail({error:i})})},e.prototype.closeConversationPane=function(){this.isConversationPanelOpen=!1},e.prototype.addScenarioMarker=function(e){var t=e.errorMessage,i=e.sendTime,s=e.scenarioMarker,n=e.cached,r=i&&Date.now()-i;this.logger.info("scenarioMarker {0}",s),this.scenario.mark(s,{ipcTimeOverhead:r,errorMessage:t,cached:n})},e.prototype.closeFileUnlockScenario=function(e){var t=this.routeDocumentViewerParams.serviceName?decodeURIComponent(this.routeDocumentViewerParams.serviceName):void 0,i=this.filesDocStageHelperService.getPivot(t),s=this.constants.scenarios.files.closeFile+"_"+i,n=this.loggingService.findScenario(s);n?n.stop({ipcTimeOverhead:e,openFileScenarioId:this.scenario&&this.scenario.id}):this.logger.error("file-unified-app-viewer: could not find scenario"),this.logger.info("navigating away from doc-stage on Unload post-message")},e.prototype.handleScenario=function(e){var t=this,i=e.status,s=e.sendTime,n=e.officeSessionId,r=e.officeBootstrapperVersion,o=s&&Date.now()-s;this.redeemPromise.then(function(s){var a=s.openWith.wac,l=a.clientThrottlingProtection,c=a.requestedCallThrottling;if(i){var d=e.deltaWithPerceivedBoot;t.scenario.stop({deltaWithPerceivedBoot:d,officeSessionId:n,ipcTimeOverhead:o,clientThrottlingProtection:l,requestedCallThrottling:c}),t.filesOpenActionSettingService.handleFileOpenPreferenceUpdate(teamspace.services.FileOpenPreference.Teams,{fileType:t.fileType,serviceName:t.serviceName,context:t.ctx,fileAction:t.filesUtilityService.getFileActionName(teamspace.services.FileOpenPreference.Teams)})}else{var h=e.errorMessage;t.scenario.fail({errorMessage:h,officeSessionId:n,ipcTimeOverhead:o,clientThrottlingProtection:l,requestedCallThrottling:c})}t.logger.info("officeSessionId {0} hostSessionId {1} officeBootstrapperVersion {2}",n,t.jsApiHostSessionId,r)})},e.prototype.handleFocus=function(e){var t=e.target.dataset.focusDirection||(e.shiftKey?"backward":"forward"),i={MessageId:"Host_AccessibilityLoopComplete",SendTime:Date.now(),Values:{Direction:t}},s={eventId:teamspace.services.ChildWindowEventRequest.FilesExperienceSendData,payload:i};(this.iframeElement||this.webviewElement).focus(),this.filesDocStageHelperService.sendPostMessage(s,this.iframeElement,this.webviewElement)},e.prototype.handleModeSwitch=function(e){var t=this;if(this.filesUtilityService.isIntegratedUXEnabled(this.fileType)){if(this.moveEditInBrowserFromMoreOptions)return void this.logger.info("ignoring App_SwitchMode post-message from wac frame when intentional RO mode is set");var i=e.Editable;if("view"===e.NewMode)this.$scope.$apply(function(){t.displayTitleBar=!0,t.isEditMode=!i}),this.filesDocStageHelperService.changeFileNameInTeamsChromeHeader(!1);else if("edit"===e.NewMode){var s=this.constants.scenarios.files.editFileFullScreen+"_"+this.serviceName,n=this.loggingService.findScenario(s);n?n.stop({jsApiHostSessionId:this.jsApiHostSessionId}):this.logger.error("scenario corresponging to excel file edit not found"),this.displayTitleBar=!1,this.isEditMode=!0,this.filesDocStageHelperService.changeFileNameInTeamsChromeHeader(!0,this.fileName)}else this.logger.error("Switched to unknown mode: "+e.NewMode)}},e.prototype.handleCopyLink=function(e){var t=this;this.logger.info("Received a Share post message from WAC, calling copyLinkFactory to prepare copy link dialog"),this.copyLinkFactory.create({file:{getExtension:function(){return t.fileType},getUrl:function(){return t.objectUrl},getBaseApiUrl:function(){return t.filesUtilityService.extractSiteUrl(t.objectUrl)},getId:function(){return t.fileId},getTitle:function(){return t.fileName},getIsSubdirectory:function(){return!1}},fileContext:{serviceName:this.serviceName,provider:void 0,threadId:this.threadId},sharepointUrl:this.objectUrl,origin:this.constants.shareDialogOrigin.wac,navId:e.Values&&e.Values.nav}).execute({selectedFilesCount:1,scope:this.$scope,onCloseFocusId:"",event:void 0})},e.prototype.showOdspShareDialog=function(e,t){var i=this;this.logger.info("Received a Share post message from WAC, calling shareDialogFactory to prepare share dialog"),this.shareDialogFactory.create({file:{getExtension:function(){return i.fileType},getUrl:function(){return i.objectUrl},getBaseApiUrl:function(){return i.filesUtilityService.extractSiteUrl(i.objectUrl)},getId:function(){return i.fileId},getTitle:function(){return i.fileName},getIsSubdirectory:function(){return!1}},fileContext:{serviceName:this.serviceName,provider:void 0,threadId:this.threadId},sharepointUrl:this.objectUrl,origin:this.constants.shareDialogOrigin.wac,navId:e.Values&&e.Values.nav,id:e.Values&&e.Values.Id,persons:e.Values&&e.Values.Persons.map(function(e){return{displayName:e.DisplayName,id:e.Id,provider:e.Provider}}),mode:t}).execute({selectedFilesCount:1,scope:this.$scope,onCloseFocusId:"",event:void 0})},e.prototype.init=function(){var e=this.getNStarViewerExpUrl();this.fileViewerExpUrl=this.$sce.trustAsResourceUrl(e)},e.prototype.getNStarViewerExpUrl=function(){var e=(this.utilityService.djb2_hash(""+this.objectUrl)||"").toString(),t=this.filesDocStageHelperService.getFilesExperienceOrigin()+"/files/apps/com.microsoft.teams.files/files/"+e+"/open";this.filesExpBaseUrl=t;var i=this.settingsService.getActiveTheme(),s=this.localizationService.getLocale(),n=this.isTabbedFile(),r={agent:"postmessage",objectUrl:this.objectUrl,fileId:this.fileId,fileType:this.fileType,messageId:this.routeDocumentViewerParams.messageId,ctx:this.ctx,scenarioId:this.scenario&&this.scenario.id||null,locale:s,isTabbedFile:n,theme:i,version:this.settingsService.getOrbitalVersion(this.constants.settings.orbitals.files)},o=this.settingsService.getRing(),a={"ring.id":o&&o.id||"",createdTime:Date.now()},l=t+"?"+Object.keys(r).filter(function(e){return r[e]}).map(function(e){return encodeURIComponent(e)+"="+encodeURIComponent(r[e])}).join("&")+"&"+Object.keys(a).map(function(e){return"setting="+e+":"+a[e]}).join("&"),c=this.utilityService.parseUrl(l),d="iframe-container.html#iframeurl="+encodeURIComponent(this.$sce.trustAsResourceUrl(c.href))+"&skipDomainValidation=true";return this.useWebview?d:l},e.prototype.webviewProcessMessage=function(e){return this.commonMessageListner({data:e.args[1]})},e.prototype.layout=function(){if(this.webviewElement&&this.$window.electronSafeIpc){this.uuid||(this.uuid=this.utilityService.generateUUID());var e=this.webviewElement.clientWidth,t=this.webviewElement.clientHeight;this.$window.electronSafeIpc.send(this.constants.events.desktopApp.webViewResize,{width:e,height:t,uuid:this.uuid})}},e.prototype.isTabbedFile=function(){var e=this.routeUtilityService.getRootRouteParams();return e&&e.middlePane&&e.middlePane.startsWith("tab::")||"pinned-tab"===this.scenario.eventData.entryPoint},e.prototype.createNewFile=function(e){if(this.isWACAppCreateNewDocumentScenarioEnabled()&&e.appID){var t=void 0;switch(e.appID){case this.constants.files.wac.applications.word:t=this.constants.files.createFileExtensions.word;break;case this.constants.files.wac.applications.excel:t=this.constants.files.createFileExtensions.excel;break;case this.constants.files.wac.applications.powerpoint:t=this.constants.files.createFileExtensions.powerpoint;break;case this.constants.files.wac.applications.visio:t=this.constants.files.createFileExtensions.visio}var i=void 0,s=void 0,n=this.personalFilesDetailsService.getPersonalSiteInfo();if(n&&(i=this.filesUtilityService.extractServerRelativeUrl(n.personalRootFolderUrl),s=n.personalSiteUrl),t&&i&&s)try{this.createFileFactory.create({fileContext:{serviceName:this.constants.files.serviceName.personal,provider:this.filesProviderFactory.create(teamspace.services.files.FilesProviderType.Sharepoint),threadId:void 0,listenerId:this.listenerRegistration.getId(),siteUrl:s,serverRelativeRootUrl:i,rootRelativeFolderUrl:void 0,sortedAscending:!1,pageSize:0,libraryId:"default",libraryTitle:void 0,templateId:e.template},extension:t}).execute()}catch(t){this.logger.info("Create new document from WAC failed. Error: {0}, WAC Session ID: {1}",t,e.wdUserSession),this.filesNotificationService.showFailureNotification(this.resources.strings.files_fileCreateFailedGeneric)}else this.logger.info("Create new document from WAC failed because of missing information. extension: {0}, serverRelativeRootUrl: {1}, siteUrl: {2}, WAC Session ID: {3}",e.appID,null==i,null==s,e.wdUserSession),this.filesNotificationService.showFailureNotification(this.resources.strings.files_fileCreateFailedGeneric)}},e.prototype.isWACAppCreateNewDocumentScenarioEnabled=function(){return this.settingsService.valueAsBoolean(this.constants.settings.names.enableWACAppCreateNewDocumentScenario)},e.prototype.rebootFile=function(e){if(e.rebootFromScratch){if(this.isTabbedFile()&&!this.isWACAppDocRebootScenarioEnabled())return void this.logger.info("wrong reboot file path");this.logger.log("Reboot Mode: "+e.rebootMode);var t=this.routeDocumentViewerParams;if(this.isWACAppDocRebootScenarioEnabled())if(e.rebootMode===n.NewDocument&&e.documentUrl){t.objectUrl=e.documentUrl,t.fileId=void 0;var i=this.filesUtilityService.getFileNameFromObjectURL(t.objectUrl),r=i?this.utilityService.getFileExtension(i):void 0;t.fileType=this.isWXPExtension(r)?r:this.fileType,t.shareUrl=void 0,t.shareId=void 0,t.rebootOverrideData=this.getRebootOverrideData(e),t.wacScenario=e.reason?e.reason:this.constants.wacScenario.rebootMRU}else e.rebootMode===n.SameDocument&&(t.rebootOverrideData=this.getRebootOverrideData(e),t.wacScenario=e.reason?e.reason:this.constants.wacScenario.rebootSameDoc);var o=s(s({},t),{reboot:!0});this.filesDocStageHelperService.changeFileNameInTeamsChromeHeader(!1);var a={documentViewerParams:o,viewerState:this.constants.states.appDocumentViewer};this.navigationService.navigateToFileViewer(a)}else this.userClickTime=void 0},e.prototype.getRebootOverrideData=function(e){return JSON.stringify({previousSessionId:e.previousSessionId,mode:e.mode,reason:e.reason,queryOverrides:e.queryOverrides,isNewSession:e.isNewSession})},e.prototype.getWacScenarioFromRouteParams=function(){return this.routeUtilityService.getRootRouteParams().wacScenario},e.prototype.getWacSessionOrigin=function(){var e=(this.useWebview?this.constants.wacSessionOriginApp.teamsElectron:this.constants.wacSessionOriginApp.teamsWeb)+"."+this.serviceName+"."+this.ctx,t=this.getWacScenarioFromRouteParams();return t&&(e+="-"+t),e},e}();t.FileUnifiedAppViewerController=a,angular.module("teamspace.fileUnifiedAppViewer",["teamspace.layoutService","teamspace.settingsService","teamspace.constants","teamspace.loggingService","teamspace.utilityService","teamspace.filesUtilityService","teamspace.routeUtilityService","teamspace.filesDocStageHelperService","teamspace.channelService","teamspace.filesMessagePaneHelper","teamspace.messageService","teamspace.storageService","teamspace.routeChangeService","teamspace.navigationService","teamspace.filesExternalLinksService"]).component("fileUnifiedAppViewer",{bindings:{fileType:"<",objectUrl:"<",scenario:"<",hideClose:"<?",onClose:"&?",userClickTime:"<",ctx:"<",redeemPromise:"<",driveItemCallStartTime:"<",displayTitleBar:"=",isEditMode:"=",moreOptions:"<?",hideSpinner:"<?",fileName:"<",serviceName:"<",threadId:"<",fileId:"<",moveEditInBrowserFromMoreOptions:"<"},template:r,controller:a})},2512:function(e,t){e.exports='<div id="file-unified-app-viewer" class="flex-fill" ng-focus="$ctrl.handleFocus($event)" tabindex="0">\n\n  <file-full-alert class="flex-fill" error="$ctrl.fileErrorCode" ng-if="$ctrl.fileErrorCode" allow-download="$ctrl.allowDownloadOnError" entity-context="::$ctrl.entityContext">\n  </file-full-alert>\n\n  <div ng-if="!$ctrl.fileErrorCode" class="flex-fill">\n    <iframe id="file-unified-app-viewer-frame" ng-if="::!$ctrl.useWebview" ng-src="{{$ctrl.fileViewerExpUrl}}" class="wopi-iframe flex-fill" frameborder="0" role="presentation" tabindex="-1" aria-hidden="true">\n    </iframe>\n\n    <webview id="file-unified-app-viewer-webview" ng-if="::$ctrl.useWebview" ng-src="{{$ctrl.fileViewerExpUrl}}" class="wopi-iframe flex-fill" frameborder="0" role="presentation" tabindex="-1" aria-hidden="true">\n    </webview>\n  </div>\n</div>\n<div class="ts-right-rail thread-right-rail file-unified-app-viewer-conversation-panel" ng-if="$ctrl.isConversationPanelOpen">\n  <div class="file-unified-app-viewer-conversation-panel-container">\n    <div class="ts-canvas-message-pane">\n      <div class="conversation-title-bar">\n        <button class="ts-sym app-icons-fill-hover conversation-close" aria-label="{{::$root.resources.strings.files_conversation_chat_pane_close_button_aria_label| translate:{fileName:$ctrl.fileName} }}" title="{{::$root.resources.strings.files_conversation_chat_pane_close_button_tooltip | translate}}" ng-click="$ctrl.closeConversationPane()" acc-role="tab-handler-close-conversation-pane" tabindex="-1">\n          <ng-include class="icon icons-close" src="\'svg/icons-close.html\'"></ng-include>\n        </button>\n      </div>\n      <div class="file-unified-app-viewer-conversation-panel-container-body">\n        <img src="https://statics.teams.cdn.office.net/hashedassets/placeholders/zero_chat-fb38701.svg" class="files-zero-chat-icon"/>\n        <h4 class="file-empty-header-text">{{$ctrl.filesConversationEmptChatPaneHeader}}</h4>\n        <h5 class="file-empty-body-text">{{$ctrl.filesConversationEmptChatPaneBody}}</h5>\n        <div class="ts-files-start-conversation">\n          <div class="message-expander">\n            <div class="ts-files-add-message" id="add-new-message" data-tid="channelNewMessageContainer" ng-disabled="!$ctrl.canPostConversation">\n              <new-message send-message="$ctrl.initiateConversation(messageData, scenario)" message-type="::$ctrl.messageType" hide-people-picker="false" conversation-id="::$ctrl.threadId">\n              </new-message>\n            </div>\n          </div>\n        </div>\n      </div>\n    </div>\n  </div>\n</div>'},2513:function(e,t,i){"use strict";var s=this&&this.__assign||function(){return(s=Object.assign||function(e){for(var t,i=1,s=arguments.length;i<s;i++){t=arguments[i];for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])}return e}).apply(this,arguments)};Object.defineProperty(t,"__esModule",{value:!0});var n=i(2514),r=function(){function e(e,t,i,s,n,r,o,a,l,c,d,h,p,u,v,f,m,g,w){var y=this;this.$scope=e,this.$window=i,this.$q=s,this.$timeout=r,this.constants=o,this.loggingService=a,this.settingsService=l,this.utilityService=c,this.authenticationService=d,this.appConfig=h,this.eventingService=p,this.filesActionService=v,this.filesUtilityService=f,this.appStateService=m,this.sharepointShareService=g,this.layoutService=w,this.postMessageId="teams",this.clientId="MicrosoftTeams",this.oneupHeader="[OneDrive:From:Embed:"+this.postMessageId+"]",this.webViewElement=null,this.loadingComplete=!0,this.encounteredRedirectError=!1,this.logger=a.newLogger("FileViewer"),this.initialActiveElement=document.getElementById("file-office-frame-container")||window,this.isDesktopApp=l.valueAsBoolean(o.settings.names.isDesktopApp);var S=!1,b=!1,I=!1;i&&i.desktopSettings&&(S=i.desktopSettings.enableWebviewPreload,b=i.desktopSettings.enableWebviewSandbox,I=i.desktopSettings.enableTabWebviews),e.triggerFileDisplay=function(){return y.initFrame()},this.useWebView=l.valueAsBoolean(o.settings.names.filesEnableOneUpWebview)&&this.isDesktopApp&&!!i.electronSafeIpc&&(S&&b||I),this.oneUpServiceUrl=t.trustAsResourceUrl(this.getOneUpServiceUrl()),this.webViewSrc="",this.host=c.parseUrl(n.absUrl()).origin,this.currentLocale=u.getLocale(),e.$on("$destroy",function(){y.removeListeners(),y.scenario.cancel()}),this.mandatoryPropertyMissingOrPreviewNotAvailable()||(this.useWebView&&this.initWebView(),this.ensureInitialFocusIsNotStolen())}return e.$inject=["$scope","$sce","$window","$q","$location","$timeout","constants","loggingService","settingsService","utilityService","authenticationService","appConfig","eventingService","localizationService","filesActionService","filesUtilityService","appStateService","sharepointShareService","layoutService"],e.prototype.initWebView=function(){var e=this,t=this.$window.electronSafeIpc;t&&this.useWebView&&(t.send(this.constants.events.desktopApp.allowWebViewCreate,{enablePreload:!0}),t.once(this.constants.events.desktopApp.webViewCreationEnabled,function(){e.webViewElement=window.document.getElementById("file-one-up-viewer-webview"),e.messageSource=e.webViewElement;e.addListener("ipc-message",function(t){return e.webviewProcessMessage(t)});e.addListener("crashed",function(t){return e.loggingService.event(e.constants.telemetry.webview.crashed,{errorEvent:JSON.stringify(t)})});e.addListener("gpu-crashed",function(t){return e.loggingService.event(e.constants.telemetry.webview.gpuCrashed,{errorEvent:JSON.stringify(t)})});e.addListener("plugin-crashed",function(t){return e.loggingService.event(e.constants.telemetry.webview.pluginCrashed,{errorEvent:JSON.stringify(t)})});e.addListener("did-fail-load",function(t){e.loggingService.event(e.constants.telemetry.webview.loadFailed,{errorEvent:JSON.stringify({errorCode:t?t.errorCode:null,errorDescription:t?t.errorDescription:null})})});e.addListener("did-finish-load",function(t){return e.scenario.eventData=s(s({},e.scenario.eventData),{frameLoaded:!0})});var t=e.layout.bind(e);e.addListener("dom-ready",t),e.$window.addEventListener("resize",t),e.$scope.$on("$destroy",function(){e.$window.removeEventListener("resize",t)}),e.webViewSrc="iframe-container.html#iframeurl=about:blank&processTag="+e.constants.files.strings.oneup}))},e.prototype.layout=function(){if(this.webViewElement&&this.$window.electronSafeIpc){this.uuid||(this.uuid=this.utilityService.generateUUID());var e=this.webViewElement.clientWidth,t=this.webViewElement.clientHeight;this.$window.electronSafeIpc.send(this.constants.events.desktopApp.webViewResize,{width:e,height:t,uuid:this.uuid})}},e.prototype.addListener=function(e,t){this.webViewElement?this.webViewElement.addEventListener(e,t):window.addEventListener(e,t),this.listeners||(this.listeners={}),this.listeners[e]=t},e.prototype.removeListeners=function(){for(var e in this.listeners)this.webViewElement?this.webViewElement.removeEventListener(e,this.listeners[e]):window.removeEventListener(e,this.listeners[e]);this.listeners=null},e.prototype.webviewProcessMessage=function(e){if((e&&e.channel)===this.constants.webViewShim.postMessageFromWebview){var t=e.srcElement||e.target;if(this.webViewElement===t)if(!e.args||e.args.length<2)this.logger.error("OneUp viewer did not receive all the params");else{var i=e.args&&e.args[0];window&&window.location&&window.location.origin===i?this.handlePostMessageFromContainer(e.args[1]):this.oneUpServiceOrigin===i?this.handlePostMessage({origin:e.args[0],data:e.args[1],source:this.webViewElement}):this.logger.error("invalid event origin {0}",i)}else this.logger.error("OneUp viewer received message from a different webview")}},e.prototype.handlePostMessageFromContainer=function(e){if(e&&e.func){if("iframeLoaded"===e.func)return void this.postFormToWebview();if("error"===e.func)return void this.handleCurrentWindowErrorMessage(e)}},e.prototype.postFormToWebview=function(){var e=this;this.getAuthToken().then(function(t){e.embedParams=e.getEmbedParams(t),e.oneUpServiceOrigin=e.utilityService.parseUrl(e.oneUpServiceUrl).origin,e.encounteredRedirectError=!1,e.webViewElement.send(e.constants.webViewShim.postFormToWebview,{url:e.getOneUpServiceUrl(),params:{context:e.embedParams}})})},e.prototype.handleCurrentWindowErrorMessage=function(e){var t="";try{t=JSON.stringify(e.args)}catch(e){t=e.toString()}this.logger.error("received errorCode: {0}, errorMessage {1} for oneup viewer","IPC error",t),this.handleError("IPC error",t)},e.prototype.initFrame=function(){var e=this;this.scenario.eventData=s(s({},this.scenario.eventData),{frameLoaded:!0}),this.encounteredRedirectError=!1,this.getAuthToken().then(function(t){var i=document.getElementById("file-one-up-viewer-frame"),s=document.getElementById("file-one-up-viewer-form"),n=document.getElementById("file-one-up-viewer-context");e.messageSource=i.contentWindow,e.embedParams=e.getEmbedParams(t);try{n.value=JSON.stringify(e.embedParams)}catch(t){e.logger.error("Exception in stringfying embed params correlationId {0} ",e.embedParams.correlationId),e.errorCode=e.constants.files.error.invalidArguments}e.registerPostMessageHandler(),s.submit()})},e.prototype.getEmbedParams=function(e){var t={id:this.postMessageId,o:this.host,ct:(new Date).getTime(),tp:!0},i=this.getOneUpThemePayload();return{authToken:e,webUrl:this.siteUrl,UniqueId:this.fileId&&this.fileId.replace(/{|}/g,""),id:this.serverRelativeUrl,embed:JSON.stringify(t),culture:this.currentLocale,client_id:this.clientId,correlationId:this.loggingService.sessionId+"-"+this.scenario.id,useHostDownload:!0,theme:i,item:this.driveItem}},e.prototype.getOneUpThemePayload=function(){var e={themePrimary:"#6264a7",themeDark:"#293370"},t={buttonPrimaryTextHovered:"#fff",buttonPrimaryTextFocused:"#fff"};return this.settingsService.getActiveTheme()===this.constants.themes.highContrast&&(e.themePrimary="#000",e.themeDark="#ffff01",e.neutralLighter="#fff",t.buttonPrimaryTextFocused="#252424",t.buttonPrimaryTextHovered="#252424"),{palette:e,semanticColors:t}},e.prototype.getOneUpServiceUrl=function(){var e=this.appConfig.oneUpServiceConstants.host,t=this.appConfig.oneUpServiceConstants.devHost;return t&&(e=e+"?devHost="+t),e},e.prototype.getAuthToken=function(e){var t=this,i=this.utilityService.parseUrl(this.siteUrl).origin;return this.filesUtilityService.updateTokenWarmingRule(i),this.authenticationService.getAuthTokens([i],e?[e]:void 0).catch(function(e){t.logger.error("Failed fetching the AuthToken. Error: {0}",e);var i=e===t.constants.events.appState.reasons.resourceDisabled;return i?t.handleError(t.constants.files.error.invalidResource,"Invalid SPO Object URL",void 0,i):t.handleError(""+t.constants.responseCode.unauthorizedAccess,t.constants.files.error.unauthorizedAccessException),t.fileErrorCode=t.constants.files.error.unknown,t.$q.reject(e)})},e.prototype.registerPostMessageHandler=function(){var e=this;this.removeListeners();this.addListener("message",function(t){return e.handlePostMessage(t.originalEvent||t)})},e.prototype.handlePostMessage=function(e){var t=this,i=e,s=this.utilityService.parseUrl(this.oneUpServiceUrl).origin;if(i&&i.origin&&i.origin.toLowerCase()===s.toLowerCase()&&i.source===this.messageSource&&_.startsWith(i.data,this.oneupHeader)){var n=i.data.substr(this.oneupHeader.length),r=JSON.parse(n||"{}");switch(r.type){case"success":var o=r;this.logger.info("success callback from oneUp {0}",o),this.stopScenario(o.previewType,o.conversationId);break;case"error":var a=r,l=a.error?a.error.code:this.constants.files.error.unknownOneUp,c=a.error?a.error.message:this.constants.files.error.unknownOneUp,d=this.settingsService.valueAsBoolean(this.constants.settings.names.enableRetryOnRedirectErrorForOneUp);this.logger.info("error callback from oneUp {0}",a),d&&r&&"RedirectError"===r.data?(this.scenario.eventData.specialCase=this.constants.errorCodes.invalidAudienceUri,this.encounteredRedirectError=!0,this.reloadFileOnRedirectError(a.conversationId)):!this.encounteredRedirectError&&this.handleError(l,c,a.conversationId,a.isExpected);break;case"download":if(this.serviceName&&this.fileDetail){var h={serviceName:this.serviceName,getContextBase:function(){return t.filesUtilityService.getContextBase(t.fileDetail,t.serviceName,void 0,t.fileDetail.objectUrl,!1)}};this.filesActionService.execute(teamspace.services.EntityActionType.Download,this.fileDetail,h)}else this.loggingService.error("oneUp download failed because fileDetail or serviceName undefined for scenario "+this.scenario.id);break;case"focusKeyInput":this.layoutService.navigateToNextLandmark(!0);break;case"getToken":var p=r,u=p.options,v=u&&u.claimsChallenge&&u.claimsChallenge.claims;this.getAuthToken(v).then(function(e){t.postTokenToOneUp(i.source,p.conversationId,e)}).catch(function(e){t.logger.error("error to fetch ssm/llt token"),t.postTokenToOneUp(i.source,p.conversationId,null,e)})}i.source&&void 0!==r.conversationId&&this.postAckMessage(i.source,r.conversationId)}},e.prototype.reloadFileOnRedirectError=function(e){var t=this;this.scenario.mark("get_updated_site_url_start"),this.sharepointShareService.getSiteResourceInfo(this.siteUrl).then(function(i){t.scenario.mark("get_updated_site_url_end"),i!==t.siteUrl?(t.updateOneUpParams(i),t.useWebView?t.postFormToWebview():t.initFrame()):(t.scenario.mark("updated_site_unchanged"),t.scenario.eventData.specialCase=null,t.handleError(t.constants.errorCodes.invalidMultiGeoCase,"Retry not needed. Not true multi geo case",e,!1))}).catch(function(i){t.scenario.mark("get_updated_site_url_fail"),t.handleError("GRAPH_"+(i.statusCode||i.errorCode),i.errorMessage,e,!1)})},e.prototype.updateOneUpParams=function(e){this.siteUrl=e;var t=this.utilityService.parseUrl(this.siteUrl).origin,i=this.utilityService.parseUrl(this.objectUrl).pathname;this.fileDetail=s(s({},this.fileDetail),{siteUrl:e,objectUrl:""+t+i})},e.prototype.postAckMessage=function(e,t){if(e){var i={type:"acknowledge",conversationId:t},s=this.oneupHeader+JSON.stringify(i);this.sendMassageToOneUpFrame(e,s)}},e.prototype.postTokenToOneUp=function(e,t,i,s){if(e){var n,r;r=i?{type:"result",conversationId:t,data:{result:"success",token:i}}:{type:"result",conversationId:t,data:{result:"error",isExpected:!1,error:{code:s&&(s.code||s.errorCode||s.statusCode),message:s&&(s.message||s.errorMessage)}}},n=this.oneupHeader+JSON.stringify(r),this.sendMassageToOneUpFrame(e,n)}else this.logger.error("invalid source")},e.prototype.sendMassageToOneUpFrame=function(e,t){if(this.useWebView&&this.webViewElement)this.webViewElement.send(this.constants.webViewShim.postMessageToWebview,t);else{var i=this.utilityService.parseUrl(this.oneUpServiceUrl).origin;e.postMessage(t,i)}},e.prototype.stopScenario=function(e,t){this.loadingComplete=!0,this.eventingService.$emit(this.constants.events.files.fileOneUpViewerLoaded,{conversationId:t,previewType:e,useWebview:this.getUseWebViewFlag(),scenario:this.scenario})},e.prototype.mandatoryPropertyMissingOrPreviewNotAvailable=function(){if(!this.siteUrl||!this.serverRelativeUrl&&!this.fileId){e=this.siteUrl?"Invalid ServerRelativeURL and FileId":"Invalid SiteURL";return this.logger.error(e),this.errorCode=this.constants.files.error.invalidArguments,this.handleError(this.errorCode,e),!0}if(this.previewAvailable=this.filesUtilityService.isOneUpSupportedFile(this.type),!this.previewAvailable){this.fileErrorCode=this.constants.errorCodes.previewNotAvailable,this.entityContext={id:this.fileId,objectUrl:this.objectUrl,serviceName:this.serviceName,title:this.fileDetail.title};var e="File Preview not available";return this.handleError(this.fileErrorCode,e,null,!0),!0}return!1},e.prototype.handleError=function(e,t,i,s){this.loadingComplete=!0,(!this.appStateService.isOnline||!this.appStateService.isConnected)&&(e=this.fileErrorCode=this.constants.errorCodes.networkOffline,t="Network is offline",s=!0),s||this.checkIfExpectedFailure(e)?this.scenario.incomplete({errorCode:e,errorMessage:t,conversationId:i,useWebview:this.getUseWebViewFlag(),isExpectedFailure:this.constants.files.isExpectedFailure.yes}):this.scenario.fail({errorCode:e,errorMessage:t,conversationId:i,useWebview:this.getUseWebViewFlag()})},e.prototype.checkIfExpectedFailure=function(e){var t=this.constants.responseCode;return-1!==[t.unauthorizedAccess,t.forbidden,t.notFound,t.notAcceptable].indexOf(Number(e))},e.prototype.getUseWebViewFlag=function(){return this.useWebView?"true":"false"},e.prototype.ensureInitialFocusIsNotStolen=function(){var e=this,t=angular.element(this.$window);this.onWindowBlur&&(t.unbind(this.constants.events.jQuery.blur,this.onWindowBlur),this.onWindowBlurDestroyHandler()),this.onWindowBlur=function(t){return e.onWindowBlurHandler(t)},t.on(this.constants.events.jQuery.blur,this.onWindowBlur),this.onWindowBlurDestroyHandler=this.$scope.$on("$destroy",function(){t.unbind(e.constants.events.jQuery.blur,e.onWindowBlur)})},e.prototype.onWindowBlurHandler=function(e){var t=this;angular.element(this.$window).unbind(this.constants.events.jQuery.blur,this.onWindowBlur),this.onWindowBlurDestroyHandler(),this.onWindowBlur=null,this.$timeout(function(){return angular.element(t.initialActiveElement).focus()},100,!1)},e}();angular.module("teamspace.fileOneUpViewer",["teamspace.settingsService","teamspace.utilityService","teamspace.authenticationService"]).component("fileOneUpViewer",{bindings:{scenario:"<",type:"<",siteUrl:"<",serverRelativeUrl:"<",fileDetail:"<",serviceName:"<",driveItem:"<",fileId:"<",objectUrl:"<"},template:n,controller:r}).directive("oneUpIframe",function(){return{restrict:"A",link:function(e,t){var i=!1;t.on("load",function(){i||(i=!0,e.triggerFileDisplay())})}}})},2514:function(e,t){e.exports='<div id="file-one-up-viewer" class="flex-fill">\n\n  <div ng-if="!$ctrl.loadingComplete">\n      <busy-animation size="medium" context="file-one-up-viewer">\n      </busy-animation>\n  </div>\n\n  <file-full-alert class="flex-fill" object-url="{{$ctrl.objectUrl}}" error="$ctrl.fileErrorCode" ng-if="$ctrl.fileErrorCode" entity-context="::$ctrl.entityContext">\n  </file-full-alert>\n\n  <div ng-style="{\'visibility\' : $ctrl.loadingComplete ? \'visible\' : \'hidden\'}" ng-if="!$ctrl.fileErrorCode" class="flex-fill">\n    <form id="file-one-up-viewer-form" target="file-one-up-viewer-frame" method="POST" action="{{$ctrl.oneUpServiceUrl}}" hidden>\n      <input id="file-one-up-viewer-context" type="text" name="context"/>\n      <input type="submit"/>\n    </form>\n\n    <iframe one-up-iframe id="file-one-up-viewer-frame" name="file-one-up-viewer-frame" ng-if="::!$ctrl.useWebView" ng-src="about:blank" sandbox="allow-forms allow-popups allow-pointer-lock allow-same-origin allow-scripts" class="wopi-iframe flex-fill" frameborder="0" role="presentation" tabindex="0" aria-hidden="true">\n    </iframe>\n\n    <webview id="file-one-up-viewer-webview" ng-if="::$ctrl.useWebView" ng-src="{{$ctrl.webViewSrc}}" class="wopi-iframe flex-fill" frameborder="0" role="presentation" tabindex="0" aria-hidden="true">\n    </webview>\n  </div>\n</div>\n'},2515:function(e,t,i){"use strict";var s=this&&this.__assign||function(){return(s=Object.assign||function(e){for(var t,i=1,s=arguments.length;i<s;i++){t=arguments[i];for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])}return e}).apply(this,arguments)};Object.defineProperty(t,"__esModule",{value:!0});var n=i(2516),r=function(){function e(e,t,i,s,n,r,o,a,l,c,d,h,p,u,v,f,m,g,w,y,S,b,I,C){var U=this;this.$q=e,this.$scope=t,this.$state=i,this.$translate=s,this.constants=n,this.resources=r,this.loggingService=o,this.utilityService=a,this.routeUtilityService=l,this.filesEntityService=c,this.filesUtilityService=d,this.filesActionService=h,this.analyticsService=p,this.filesActionRouter=u,this.filesProviderFactory=v,this.settingsService=f,this.sharepointScenarioHandler=m,this.sharePointFilePreviewService=g,this.filesRedeemService=y,this.navigationService=S,this.filesDocStageHelperService=I,this.filesSharingHelper=C,this.isPreProcessingComplete=void 0,this.useNStarViewerExpInMainWindow=!1,this.displayTitleBar=!0,this.showSpinner=!0,this.moveEditInBrowserFromMoreOptions=!1,this.scenarioComplete=!1,this.fileDetailsFetchSuccess=!1,this.logger=o.newLogger("FileViewer");var E=l.getRootRouteParams();this.ctx=E.ctx?decodeURIComponent(E.ctx):void 0,this.accessType=E.accessType;var T;!this.objectUrl||E.fileName&&this.fileType||(T=d.getFileNameFromObjectURL(this.objectUrl)),this.fileName=E.fileName?E.fileName:T,this.fileId=this.fileId&&this.fileId.replace(/{|}/g,""),!this.shareUrl&&E.shareUrl&&(this.shareUrl=E.shareUrl),!E.navId&&E.shareUrl&&(E.navId=this.getNavIdFromShareUrl(E.shareUrl)),!this.shareId&&E.shareId&&(this.shareId=E.shareId),C.shareLogInfo(n.files.actionLogs.fileOpen,this.fileId,this.shareUrl?"shareUrl exists":"shareUrl does not exist"),this.isNewFile=this.ctx===n.scenarios.files.newFileCreationContext;var A=f.valueAsBoolean(n.settings.names.filesEnableSharePointFilePreviewService);i.current.name!==n.states.appDocumentViewer&&i.current.name!==n.states.appAppsAppFileSection||E.viewerAction!==n.files.fileActions.viewer.edit?(this.viewerType=A?g.getPreviewerType(this.fileType):teamspace.services.files.modules.sharePoint.FilePreviewerTypes.Wac,this.wacEdit=!1):(this.viewerType=A?g.getEditorType(this.fileType):teamspace.services.files.modules.sharePoint.FilePreviewerTypes.Wac,this.wacEdit=!0);var P=this.getActionType();if(this.objectUrl&&d.isNStarViewerExpInMainWindowEnabled(this.fileType)&&b.getBrowser()!==n.browser.ie&&(this.wacEdit=!a.isVisioFile(this.fileType)||P===n.wopiActions.edit,this.useNStarViewerExpInMainWindow=!0,d.isIntegratedUXEnabled(this.fileType)&&(this.displayTitleBar=P===n.wopiActions.view||!a.isVisioFile(this.fileType)&&!this.wacEdit),this.viewerType=teamspace.services.files.modules.sharePoint.FilePreviewerTypes.UnifiedApp,this.fileType===n.fileExtensions.email&&(this.viewerType=teamspace.services.files.modules.sharePoint.FilePreviewerTypes.Email,this.setFileDetails()),this.hideSpinner=function(){return U.showSpinner=!1}),w.$on(t,n.events.files.fileOneUpViewerLoaded,function(e,t){U.oneUpViewerLoadSucessMessage=t,U.stopScenario()}),this.useOneUp=this.viewerType===teamspace.services.files.modules.sharePoint.FilePreviewerTypes.OneUp,this.scenario=o.findScenario(this.scenarioName),this.scenario||(o.warn("file-office-frame: could not find scenario"),this.scenario=o.newScenario(this.scenarioName,null,function(){U.scenarioComplete=!0},n.timeInMiliseconds.tenMinutes),this.scenario.eventData={type:this.fileType,entryPoint:this.ctx,serviceName:this.serviceName}),this.scenario.eventData.viewerType=this.viewerType,this.scenario.eventData.type=d.scrubUnknownFileExtensions(this.fileType),this.scenario.eventData.isShareUrlPresent=!!this.shareUrl,this.logger.info("sessionId {0} scenarioId {1} viewerType {2}",o.sessionId,this.scenario.id,this.viewerType),this.baseUrl||(this.baseUrl=d.extractSiteUrl(this.objectUrl)),this.useOneUp&&(this.oneUpParams={baseUrl:this.baseUrl,fileType:this.fileType,scenario:this.scenario,serverRelativeUrl:d.extractServerRelativeUrl(this.objectUrl)}),t.$on("$destroy",function(){U.scenarioComplete||U.scenario.cancel()}),this.logger.info("type {0} isOneUp {1} isUnified {2}",this.fileType,this.useOneUp,this.useNStarViewerExpInMainWindow),this.useOneUp&&!a.isDocumentType(this.fileType))return this.setFileDetails(),void this.redeemFile(this.viewerType,E,T,P,!1);this.useNStarViewerExpInMainWindow?this.redeemFile(this.viewerType,E,T,P,!1):this.redeemFile(this.viewerType,E,T,P)}return e.$inject=["$q","$scope","$state","$translate","constants","resources","loggingService","utilityService","routeUtilityService","filesEntityService","filesUtilityService","filesActionService","analyticsService","filesActionRouter","filesProviderFactory","settingsService","sharepointScenarioHandler","sharePointFilePreviewService","eventingService","filesRedeemService","navigationService","platformDetectService","filesDocStageHelperService","filesSharingHelper"],e.prototype.getNavIdFromShareUrl=function(e){var t=this.utilityService.getQueryParameters(e);return t?t.nav:null},e.prototype.getActionType=function(){if(this.isNewFile)return this.constants.wopiActions.editNew;var e=this.utilityService.getIconClass({type:this.fileType}),t=this.settingsService.valueAsBoolean(this.constants.settings.names.enableDefaultToROViewUnifiedAppWord);switch(e){case this.constants.css.fileIcons.word:return t?this.constants.wopiActions.view:this.constants.wopiActions.open;case this.constants.css.fileIcons.excel:return this.constants.wopiActions.open;case this.constants.css.fileIcons.powerpoint:return this.constants.wopiActions.edit;case this.constants.css.fileIcons.visio:return this.wacEdit?this.constants.wopiActions.edit:this.constants.wopiActions.open;case this.constants.css.fileIcons.onenote:return this.constants.wopiActions.edit;default:return}},e.prototype.redeemFile=function(e,t,i,s,n){var r=this;void 0===n&&(n=!0);var o=this.useNStarViewerExpInMainWindow?teamspace.services.IFileRedeemScenario.NorthStarFileViewer:teamspace.services.IFileRedeemScenario.Thumbnail;if(this.logger.info("isDetailCallNeeded {0} isShareUrl {1} isNStarViewerExperience {2}",n,this.shareUrl,this.useNStarViewerExpInMainWindow),this.shareUrl||this.viewerType==teamspace.services.files.modules.sharePoint.FilePreviewerTypes.UnifiedApp){var a={fileId:this.fileId,shareId:this.shareId},l=this.settingsService.valueAsBoolean(this.constants.settings.names.enableInValidAudienceErrorRetryForUnifiedApps)&&(this.viewerType==teamspace.services.files.modules.sharePoint.FilePreviewerTypes.UnifiedApp||this.viewerType==teamspace.services.files.modules.sharePoint.FilePreviewerTypes.OneUp);this.scenario.mark("redeem-call-started"),this.driveItemCallStartTime=Date.now(),this.redeemPromise=this.filesRedeemService.redeemFile(this.objectUrl,this.shareUrl,o,s,a,this.baseUrl,l,this.scenario.name),this.redeemPromise.then(function(s){r.scenario.mark("redeem-call-finished"),r.driveItem=s,r.isPreProcessingComplete=!0,n&&r.fetchFileDetailsAndSetHeaders(e,t,i)}).catch(function(e){r.scenario.mark("redeem-call-failed"),r.onFileLoadError(e,!0)}).finally(function(){if(r.setFileDetails(),r.useNStarViewerExpInMainWindow){if(r.isPreProcessingComplete&&!r.isValidDriveItem(r.driveItem,r.fileType)){r.scenario.mark("redeem-call-incomplete");var e={statusCode:200,message:"jsAPI parameters missing in driveItem API response"};return r.logger.error("jsapi params missing in redeem call response"),void r.onFileLoadError(e,!0)}r.viewerType==teamspace.services.files.modules.sharePoint.FilePreviewerTypes.UnifiedApp&&r.isValidDriveItem(r.driveItem,r.fileType)&&fetch(r.driveItem.openWith.wac.bootstrapperUrl).then(function(e){var t=performance.getEntriesByName(r.driveItem.openWith.wac.bootstrapperUrl).slice(-1)[0],i=t?{latency:t.duration,cached:0===t.transferSize}:void 0;r.scenario.mark("JSAPI script prefetched",i)}).catch(function(e){r.scenario.mark("JSAPI prefetch failed")})}})}else this.isPreProcessingComplete=!0,n&&this.fetchFileDetailsAndSetHeaders(e,t,i)},e.prototype.isValidDriveItem=function(e,t){return this.viewerType===teamspace.services.files.modules.sharePoint.FilePreviewerTypes.Email||!!(this.driveItem&&this.driveItem.openWith&&this.driveItem.openWith.wac)},e.prototype.fetchFileDetailsAndSetHeaders=function(e,t,i){var s,n=this,r=this.filesProviderFactory.create(teamspace.services.files.FilesProviderType.Sharepoint),o=this.filesActionRouter.getItemDetailsRepository(r),a=!0;(this.useNStarViewerExpInMainWindow||this.isNStarViewerType())&&(a=!1);var l=t.rootContext?decodeURIComponent(t.rootContext):void 0;if(this.getByFileIdAndBaseUrl(l)){var c=this.fileType?this.fileType:this.utilityService.getFileExtension(i);s=o.getById(this.baseUrl,this.fileId,c===this.constants.onenote.extension,this.isNewFile,a)}else s=this.objectUrl?o.getByUrl(this.objectUrl,a):this.$q.reject(teamspace.services.files.FilesError.createFromInternalError(this.constants.files.internalErrorCodes.common.argumentError,"File is not specified."));s.then(function(e){n.scenario.mark("details-call-finished"),n.fileDetail=e.value,n.fileDetail.size&&(n.scenario.eventData.size=n.utilityService.bytesToMb(n.fileDetail.size)),n.useOneUp||(n.wacUrl=n.wacEdit?n.fileDetail.wacUrlEdit:n.fileDetail.wacUrl),n.fileName||(n.fileName=n.fileDetail.title);var t=n.getSiteUrlFromFileDetails(n.fileDetail);if(t=decodeURIComponent(t),n.baseUrl!==t&&(n.baseUrl=t),n.useOneUp){if(!n.oneUpParams){var i=decodeURIComponent(n.fileDetail.objectUrl);n.oneUpParams={baseUrl:t,fileType:n.fileType,scenario:n.scenario,serverRelativeUrl:n.filesUtilityService.extractServerRelativeUrl(i)}}n.oneUpParams.fileDetail=n.fileDetail,n.oneUpParams.serviceName=n.serviceName}return n.fileDetail}).then(function(e){n.initializeTitleAndStopScenario()}).catch(function(e){n.logger.error("Error in details call"),n.onFileLoadError(e,!1,!0)})},e.prototype.setFileDetails=function(){var e=this.objectUrl;this.isPreProcessingComplete&&this.driveItem&&this.driveItem.webUrl&&(e=this.driveItem.webUrl),this.fileDetail={objectId:this.fileId,objectUrl:this.driveItem&&this.driveItem.webDavUrl?this.driveItem.webDavUrl:this.objectUrl,title:this.driveItem&&this.driveItem.name?this.driveItem.name:this.fileName,type:this.fileType,wacUrl:"",wacUrlEdit:"",openInWindowFileUrl:e,isPersonal:this.serviceName===this.constants.files.serviceName.personal,siteUrl:this.driveItem&&this.driveItem.sharepointIds&&this.driveItem.sharepointIds.siteUrl?this.driveItem.sharepointIds.siteUrl:this.baseUrl},this.oneUpParams&&(this.oneUpParams.fileDetail=this.fileDetail,this.oneUpParams.serviceName=this.serviceName,this.driveItem&&this.driveItem.webDavUrl&&this.objectUrl!==this.driveItem.webDavUrl&&(this.scenario.mark("oneup-params-updated-with-driveitem"),this.objectUrl=this.driveItem.webDavUrl,this.oneUpParams.baseUrl=this.filesUtilityService.extractSiteUrl(this.objectUrl),this.oneUpParams.serverRelativeUrl=this.filesUtilityService.extractServerRelativeUrl(this.objectUrl))),this.initializeTitleAndStopScenario()},e.prototype.initializeTitleAndStopScenario=function(){this._initializeTitleBar(),this.fileDetailsFetchSuccess=!0,this.stopScenario()},e.prototype.getByFileIdAndBaseUrl=function(e){return this.baseUrl&&this.fileId&&(e===this.constants.scenarios.files.itemsViewRootContext||this.fileType!==this.constants.onenote.extension)},e.prototype.getSiteUrlFromFileDetails=function(e){return e&&e.objectUrl||this.onFileLoadError({errorCode:void 0,internalErrorCode:""+this.constants.files.internalErrorCodes.common.invalidUrl,statusCode:200},!1,!0),e.siteUrl?e.siteUrl:(e.parentListUrl||this.onFileLoadError({errorCode:void 0,internalErrorCode:""+this.constants.files.internalErrorCodes.sharepoint.missingListUrl,statusCode:200},!1,!0),this.filesUtilityService.extractSiteUrl(e.objectUrl,e.parentListUrl))},e.prototype.stopScenario=function(){if(this.oneUpViewerLoadSucessMessage&&this.fileDetailsFetchSuccess&&this.oneUpParams&&this.oneUpParams.scenario&&this.oneUpViewerLoadSucessMessage.scenario===this.scenario){var e={conversationId:this.oneUpViewerLoadSucessMessage.conversationId,previewType:this.oneUpViewerLoadSucessMessage.previewType,useWebview:this.oneUpViewerLoadSucessMessage.useWebview};this.oneUpParams.scenario.stop(e)}},e.prototype._initializeTitleBar=function(){var e=this;if(this.fileDetail&&!this.isSPOUrlInvalid){var t={serviceName:this.serviceName,getContextBase:function(){return e.filesUtilityService.getContextBase(e.fileDetail,e.serviceName,void 0,e.fileDetail.objectUrl,!1)}},i=this.filesActionService.isReadOnlyNotTeamOwner({accessType:this.accessType,threadId:this.threadId}),n=this.filesEntityService.getOpenInText(this.fileDetail.type),r=this.settingsService.valueAsBoolean(this.constants.settings.names.filesEnableSharePointFilePreviewService),o=this.utilityService.getIconClass({type:this.fileType}),a=this.settingsService.valueAsBoolean(this.constants.settings.names.enableDefaultToROViewUnifiedAppWord),l=this.settingsService.valueAsBoolean(this.constants.settings.names.enableDirectDiscoveryOfEditInBrowser);if(this.moveEditInBrowserFromMoreOptions=o===this.constants.css.fileIcons.word&&a&&l,this.moveEditInBrowserFromMoreOptions)this.wacEdit=!1,this.editAction=function(){return e.filesActionService.execute(teamspace.services.EntityActionType.OpenInNewTab,e.fileDetail,s(s({},t),{isWordROAndOpenInBrowserEnabled:e.moveEditInBrowserFromMoreOptions}))},this.titleBarPrimaryOptions={primaryButtonText:this.$translate.instant(this.resources.strings.files_editButtonLabel),primaryButtonAria:this.$translate.instant(this.resources.strings.files_editButtonLabel)};else if(this.filesUtilityService.isVisioDesktopAppOnlyEditEnabled(this.fileDetail.type)){this.editAction=function(){return e.filesActionService.execute(teamspace.services.EntityActionType.OpenInDesktopApp,e.fileDetail,t)};var c=this.filesUtilityService.getProductLabels(this.fileDetail.type);this.titleBarPrimaryOptions={primaryButtonText:c.desktopProductName,primaryButtonAria:this.$translate.instant(this.resources.strings.files_editButtonAriaLabelVisio)}}else{var d=this.settingsService.valueAsBoolean(this.constants.settings.names.enableOfficeViewerEdit);d&&(this.editAction=function(){return e.changeToEdit()});var h=i?this.resources.strings.files_menuLabelOpenInTeams:this.resources.strings.files_menuLabelEditInTeams,p=d&&(!r||this.sharePointFilePreviewService.canEditFileInTeams(this.fileDetail.type)),u={id:"office-edit-in-teams",displayName:this.$translate.instant(h),class:"open-in-teams-entry",click:function(){return e.changeToEdit()},shouldBeHidden:function(){return!p},svgPath:"svg/icons-msft-teams.html"},v=r?this.sharePointFilePreviewService.canEditFileInDesktopApp(this.fileDetail.type)&&this.fileDetail.objectUrl:this.filesActionService.canUse(teamspace.services.EntityActionType.OpenInDesktopApp,this.fileDetail,{serviceName:this.serviceName}),f={id:"office-open-in-desktop-app",displayName:n.openInDesktopAppText,click:function(){return e.filesActionService.execute(teamspace.services.EntityActionType.OpenInDesktopApp,e.fileDetail,t)},shouldBeHidden:function(){return!v},svgPath:"svg/"+this.utilityService.getSVGBase(this.fileDetail.type,"icons-{type}")+".html"},m=r?this.sharePointFilePreviewService.canEditFileInSharePoint(this.fileDetail.type)&&this.fileDetail.openInWindowFileUrl:this.filesActionService.canUse(teamspace.services.EntityActionType.OpenInNewTab,this.fileDetail,{serviceName:this.serviceName});this.openInNewTabMenuItem={id:"office-open-in-new-tab",displayName:n.openInNewTabText,click:function(i,n,r,o,a){a?e.filesActionService.execute(teamspace.services.EntityActionType.OpenInNewTab,s(s({},e.fileDetail),{previousSessionId:a}),t):e.filesActionService.execute(teamspace.services.EntityActionType.OpenInNewTab,e.fileDetail,t)},shouldBeHidden:function(){return!m},svgPath:"svg/"+this.utilityService.getSVGBase(this.fileDetail.type,"icons-{type}")+".html"};var g=i?this.resources.strings.files_openButtonLabel:this.resources.strings.files_editButtonLabel;this.titleBarPrimaryOptions={primaryButtonText:this.$translate.instant(g),primaryButtonAria:this.$translate.instant(this.resources.strings.files_editButtonAriaLabel),dropdownButtonText:this.$translate.instant(this.resources.strings.files_moreEditOptionsButtonLabel),options:[u,f,this.openInNewTabMenuItem]}}this.titleBarMoreOptions=[{id:"download-office-document",displayName:this.$translate.instant(this.resources.strings.files_menuLabelDownload),click:function(){return e.filesActionService.execute(teamspace.services.EntityActionType.Download,e.getDownloadTarget(),t)},shouldBeHidden:function(){return!e.filesActionService.canUse(teamspace.services.EntityActionType.Download,e.fileDetail,{serviceName:e.serviceName})},svgPath:"svg/icons-download.html"},{id:"open-office-document-in-sharepoint",displayName:this.filesActionService.textFor(teamspace.services.EntityActionType.OpenInSharePoint,{serviceName:this.serviceName}),click:function(){return e.filesActionService.execute(teamspace.services.EntityActionType.OpenInSharePoint,e.fileDetail,null)},shouldBeHidden:function(){return!e.filesActionService.canUse(teamspace.services.EntityActionType.OpenInSharePoint,e.fileDetail,{serviceName:e.serviceName})},svgPath:"svg/"+this.filesActionService.iconFor(teamspace.services.EntityActionType.OpenInSharePoint,this.fileDetail,{serviceName:this.serviceName}).first+".html"},{id:"office-open-in-desktop-app",displayName:n.openInDesktopAppText,click:function(){return e.filesActionService.execute(teamspace.services.EntityActionType.OpenInDesktopApp,e.fileDetail,t)},shouldBeHidden:function(){return!e.filesActionService.canUse(teamspace.services.EntityActionType.OpenInDesktopApp,e.fileDetail,{serviceName:e.serviceName})||!e.moveEditInBrowserFromMoreOptions&&!e.wacEdit},svgPath:"svg/"+this.utilityService.getSVGBase(this.fileDetail.type,"icons-{type}")+".html"},{id:"office-open-in-new-tab",displayName:n.openInNewTabText,click:function(i,n,r,o,a){a?e.filesActionService.execute(teamspace.services.EntityActionType.OpenInNewTab,s(s({},e.fileDetail),{previousSessionId:a}),t):e.filesActionService.execute(teamspace.services.EntityActionType.OpenInNewTab,e.fileDetail,t)},shouldBeHidden:function(){return!e.filesActionService.canUse(teamspace.services.EntityActionType.OpenInNewTab,e.fileDetail,{serviceName:e.serviceName})||!!e.moveEditInBrowserFromMoreOptions||!e.wacEdit},svgPath:"svg/"+this.utilityService.getSVGBase(this.fileDetail.type,"icons-{type}")+".html"}],this.threadId&&(this.titleBarConversationInfo={threadId:this.threadId,objectId:this.fileDetail.objectId,serviceName:this.serviceName,objectUrl:this.fileDetail.objectUrl})}},e.prototype.getDownloadTarget=function(){return{objectId:this.fileId,title:this.driveItem&&this.driveItem.name?this.driveItem.name:this.fileName,objectUrl:this.driveItem&&this.driveItem.webDavUrl?this.driveItem.webDavUrl:this.objectUrl,serviceName:this.serviceName,shareUrl:this.shareUrl,shareId:this.shareId,siteUrl:this.driveItem&&this.driveItem.sharepointIds&&this.driveItem.sharepointIds.siteUrl?this.driveItem.sharepointIds.siteUrl:this.baseUrl}},e.prototype.getAccessibleIframeNotice=function(){if(this.openInNewTabMenuItem)return this.viewerType===teamspace.services.files.modules.sharePoint.FilePreviewerTypes.UnifiedApp?this.$translate.instant(this.resources.strings.files_accessible_iframe_notice):this.$translate.instant(this.resources.strings.files_inaccessible_iframe_notice)},e.prototype.openInNewTab=function(e){e.which===this.constants.keyCodes.enter&&e.target===e.currentTarget&&(this.openInNewTabMenuItem.click(),e.preventDefault(),this.analyticsService.onPanelAction(this.$scope,{action:{gesture:teamspace.components.PanelActionGesture.click,scenario:teamspace.components.PanelActionScenario.openFile,scenarioType:teamspace.components.PanelActionScenarioType.files},module:{name:teamspace.shared.AttributeHelper.tryGetEnum(teamspace.components.PanelModuleName.documentStage.toString(),teamspace.components.PanelModuleName,this.loggingService).toString(),type:teamspace.components.PanelModuleType.viewer,summary:"Opening document from accessible iframe wrapper"},dataBag:{wacAccessibilityOpenOnline:!0}}))},e.prototype.changeToEdit=function(){var e=this;if(this.scenarioComplete||this.scenario.cancel({errorCode:"changeToEdit"}),this.scenarioComplete=!1,this.scenario=this.loggingService.newScenario(this.constants.scenarios.files.editFileFullScreen+"_"+this.serviceName,null,function(){e.scenarioComplete=!0}),this.scenario.eventData={type:this.fileType,entryPoint:this.ctx,serviceName:this.serviceName,viewerType:this.viewerType},this.$state.current.name==this.constants.states.appDocumentViewer){var t=this.routeUtilityService.getRootRouteParams();t.viewerAction=this.constants.files.fileActions.viewer.edit;var i={documentViewerParams:t,viewerState:this.constants.states.appDocumentViewer};this.navigationService.navigateToFileViewer(i,{location:"replace",notify:!1})}this.viewerType===teamspace.services.files.modules.sharePoint.FilePreviewerTypes.UnifiedApp?(this.filesDocStageHelperService.sendPostMessage({eventId:teamspace.services.ChildWindowEventRequest.FilesExperienceSendData,payload:{MessageId:"Host_SwitchMode",SendTime:Date.now(),Values:{NewMode:"edit"}}}),this.displayTitleBar=!1,this.filesDocStageHelperService.changeFileNameInTeamsChromeHeader(!0,this.fileName)):this.wacUrl=this.fileDetail.wacUrlEdit,this.wacEdit=!0,this.utilityService.isEditableVisioFileExtension(this.fileType)&&this.fileDetail.openInWindowFileUrl.includes("action=default")&&(this.fileDetail.openInWindowFileUrl=this.fileDetail.openInWindowFileUrl.replace("action=default","action=edit"))},e.prototype.onFileLoadError=function(e,t,i){void 0===t&&(t=!1),void 0===i&&(i=!1),this.isSPOUrlInvalid=this.checkForInvalidSPOUrl(e),this.isSPOUrlInvalid?this.fileErrorCode=this.constants.files.error.unknown:this.fileErrorCode=e&&(e.statusCode||e.errorCode||e.internalErrorCode||e.code)||this.constants.files.error.unknown;var s=_.get(e,"errorMessage.error");if(this.errorReasonForTelemetry=s&&s["error.errorMessage.error"],t||i){if(!e)return void this.scenario.fail({errorCode:"Unknown Error"});var n=e.errorMessage&&e.errorMessage.error,r=n&&n.innerError,o=e.errorCode||e.code||n&&n.code,a=n&&n.message;if(a=a||(e.message||e.internalErrorCode||this.errorReasonForTelemetry||this.fileErrorCode),this.scenario.eventData.SPRequestId=r&&r["request-id"],o===this.constants.errorCodes.networkOffline)return void this.scenario.incomplete({errorCode:o,errorMessage:a});var l=e.statusCode;if(!l)return void this.scenario.fail({errorCode:o,errorMessage:a});if("number"!=typeof l){var c="type: "+typeof l+", status: "+l;return a=a?c+", message: "+a:c,void this.scenario.fail({statusCode:l,errorCode:o,errorMessage:a})}switch(l){case this.constants.responseCode.clientFailure:case this.constants.responseCode.badRequest:case this.constants.responseCode.internalServerError:case this.constants.responseCode.serviceUnavailable:case this.constants.responseCode.ok:this.scenario.fail({statusCode:l,errorCode:o,errorMessage:a});break;default:this.scenario.incomplete({statusCode:l,errorMessage:a,errorCode:o})}}else if(this.scenario.mark("scenario-stop-pending"),this.filesSharingHelper.shareLogInfo(this.constants.files.actionLogs.fileOpenError,this.fileId,this.fileErrorCode,this.errorReasonForTelemetry),this.scenario){var d={errorCode:e&&(e.errorCode||e.internalErrorCode),statusCode:e&&e.statusCode};this.sharepointScenarioHandler.getFilesScenario(d,this.constants.files.scenarioActions.getFiles).finishScenario(this.scenario)}},e.prototype.checkForInvalidSPOUrl=function(e){return!!e&&(e===this.constants.events.appState.reasons.resourceDisabled||e.errorMessage===this.constants.events.appState.reasons.resourceDisabled||e.errorCode===this.constants.errorCodes.acquireTokenOtherError)},e.prototype.isNStarViewerType=function(){return this.viewerType===teamspace.services.files.modules.sharePoint.FilePreviewerTypes.UnifiedApp||this.viewerType===teamspace.services.files.modules.sharePoint.FilePreviewerTypes.Email},e}();angular.module("teamspace.fileOfficeFrame",["teamspace.loggingService","teamspace.utilityService","teamspace.routeUtilityService","teamspace.filesUtilityService","teamspace.filesActionService","teamspace.filesEntityService","teamspace.filesRedeemService","teamspace.analyticsService","teamspace.platformDetectService","teamspace.authenticationService","teamspace.services.files.modules.sharePoint.sharePointFileDetailsRepository","teamspace.services.files.modules.sharePoint.sharePointFilePreviewService","teamspace.services.files.modules.scenarios.sharepointScenarioHandler","teamspace.services.files.modules.sharePoint.vroom.sharepointShareService","teamspace.navigationService","teamspace.filesDocStageHelperService","teamspace.services.files.modules.sharePoint.filesSharingHelper"]).component("fileOfficeFrame",{bindings:{serviceName:"<",fileType:"<",objectUrl:"<",baseUrl:"<",fileId:"=",threadId:"<?",onTitleBarClosed:"&?",scenarioName:"<",userClickTime:"<",shareUrl:"<",shareId:"<"},template:n,controller:r})},2516:function(e,t){e.exports='<div id="file-office-frame" class="flex-fill">\n\n  \x3c!-- busy animation --\x3e\n  <busy-animation size="medium" ng-if="!($ctrl.fileDetail || ($ctrl.useOneUp && $ctrl.oneUpParams && !$ctrl.wacEdit)) && !$ctrl.fileErrorCode && !$ctrl.useNStarViewerExpInMainWindow" context="file-office-frame">\n  </busy-animation>\n\n  <file-document-title-bar id="ts-file-document-title-bar" ng-show="$ctrl.displayTitleBar || $ctrl.fileErrorCode" is-edit-mode="$ctrl.wacEdit" display-title-bar="$ctrl.displayTitleBar" edit-action="$ctrl.editAction" file-name="::$ctrl.fileName" file-type="::$ctrl.fileType" file-id="::$ctrl.fileId" hide-close="::!$ctrl.onTitleBarClosed" on-close="::$ctrl.onTitleBarClosed()" is-enabled="true" primary-options="::$ctrl.titleBarPrimaryOptions" more-options="::$ctrl.titleBarMoreOptions" move-edit-in-browser-from-more-options="$ctrl.moveEditInBrowserFromMoreOptions" error="$ctrl.fileErrorCode" error-reason-for-telemetry="$ctrl.errorReasonForTelemetry" conversation-info="::$ctrl.titleBarConversationInfo" viewer-type="::$ctrl.viewerType">\n  </file-document-title-bar>\n\n  <file-full-alert class="flex-fill" error="$ctrl.fileErrorCode" ng-if="$ctrl.fileErrorCode" object-url="{{$ctrl.objectUrl}}" share-url="{{$ctrl.shareUrl}}">\n  </file-full-alert>\n\n  <div class="office-frame flex-fill" ng-if="!$ctrl.fileErrorCode">\n    <div tabindex="0" set-focus="true" id="file-office-frame-container" acc-role="tab-handler-document-viewer-frame" role="application" class="flex-fill office-viewer-container" aria-label="{{::$ctrl.getAccessibleIframeNotice()}}" ng-if="::$ctrl.isPreProcessingComplete && !$ctrl.useNStarViewerExpInMainWindow" ng-keydown="$ctrl.openInNewTab($event)">\n      <file-office-viewer ng-if="$ctrl.fileDetail && ($ctrl.wacEdit || !$ctrl.useOneUp)" type="::$ctrl.fileDetail.type" scenario="$ctrl.scenario" wac-url-source="$ctrl.wacUrl" wac-edit="$ctrl.wacEdit" ctx="::$ctrl.ctx" file-type="::$ctrl.fileType" class="flex-fill">\n      </file-office-viewer>\n      <file-one-up-viewer ng-if="$ctrl.oneUpParams && !$ctrl.wacEdit" type="::$ctrl.oneUpParams.fileType" scenario="$ctrl.oneUpParams.scenario" site-url="$ctrl.oneUpParams.baseUrl" server-relative-url="$ctrl.oneUpParams.serverRelativeUrl" file-detail="::$ctrl.oneUpParams.fileDetail" object-url="::$ctrl.objectUrl" service-name="::$ctrl.oneUpParams.serviceName" drive-item="$ctrl.driveItem" file-id="::$ctrl.fileId" class="flex-fill">\n      </file-one-up-viewer>\n    </div>\n\n    <div tabindex="0" set-focus="true" id="file-office-frame-experience-container" class="flex-fill office-viewer-container" role="application" aria-label="{{::$ctrl.getAccessibleIframeNotice()}}" ng-if="$ctrl.useNStarViewerExpInMainWindow" ng-keydown="$ctrl.openInNewTab($event)">\n      <div id="ts-unified-app-loader" ng-if="$ctrl.showSpinner">\n        <busy-animation size="medium" context="file-unified-app-viewer">\n        </busy-animation>\n      </div>\n      \x3c!-- ng-show ensures that files experience is not visible till redeem call succeeds.--\x3e\n      <file-unified-app-viewer ng-show="::$ctrl.isPreProcessingComplete" is-edit-mode="$ctrl.wacEdit" file-type="::$ctrl.fileType" object-url="::$ctrl.objectUrl" user-click-time="::$ctrl.userClickTime" scenario="::$ctrl.scenario" ctx="::$ctrl.ctx" drive-item-call-start-time="::$ctrl.driveItemCallStartTime" class="flex-fill file-unified-app-viewer-container" redeem-promise="$ctrl.redeemPromise" hide-spinner="$ctrl.hideSpinner" display-title-bar="$ctrl.displayTitleBar" more-options="::$ctrl.titleBarMoreOptions" hide-close="::!$ctrl.onTitleBarClosed" on-close="::$ctrl.onTitleBarClosed()" file-name="::$ctrl.fileName" thread-id="::$ctrl.threadId" service-name="::$ctrl.serviceName" move-edit-in-browser-from-more-options="$ctrl.moveEditInBrowserFromMoreOptions" file-id="::$ctrl.fileId">\n      </file-unified-app-viewer>\n    </div>\n  </div>\n</div>'},2517:function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s=i(2518),n=function(){function e(e,t,i,s,n,r,o,a,l,c){var d=this;this.$scope=e,this.$sce=t,this.$window=i,this.$location=s,this.$timeout=n,this.constants=r,this.utilityService=a,this.filesUtilityService=c,this.initialActiveElement=document.getElementById("file-office-frame-container")||window,this.isOneNote=r.fileExtensions.onenote.indexOf(this.type)>=0,this.isVisio=r.fileExtensions.visio.indexOf(this.type)>=0,this.isElectronApp=l.isElectron(),this.useHwaWebView=l.isHwa()&&o.valueAsBoolean(r.settings.names.enableMsWebViewFileOfficeViewer),this.useElectronWebView=this.isElectronApp;var h=i.electronSafeIpc;this.useHwaWebView?(this.init(),this._stopFullScreenScenario()):h&&this.useElectronWebView?(h.send(r.events.desktopApp.allowWebViewCreate),h.once(r.events.desktopApp.webViewCreationEnabled,function(){d.init(),d._stopFullScreenScenario(),d.isWebViewCreationEnabled=!0})):(this.init(),this._registerScenarioEnd()),this._ensureInitialFocusIsNotStolen()}return e.$inject=["$scope","$sce","$window","$location","$timeout","constants","settingsService","utilityService","desktopUtilityService","filesUtilityService"],e.prototype.$onChanges=function(e){var t=this;if(e.wacUrlSource&&!e.wacUrlSource.isFirstChange()){var i=this.$window.electronSafeIpc;i&&this.useElectronWebView&&this.isWebViewCreationEnabled||this.useHwaWebView?(this.init(),this._stopFullScreenScenario()):i&&this.useElectronWebView||(this.wacUrl=null,this.$timeout(function(){return t.init()},0,!1),this._registerScenarioEnd())}},e.prototype.init=function(){var e=this,t=this.wacUrlSource+"&hh=1",i=t.match(/sc=pmo[^&]*/g);t=t.replace(/sc=.*?&/g,""),this.wacEdit?t+="&sc=OwaEdit":i&&i.length&&(t=t+"&"+i[0]),t+="&uih=Teams";var s=this.filesUtilityService.isNStarViewerExpInMainWindowEnabled(this.fileType);t=this.ctx===this.constants.scenarios.files.newFileCreationContext&&s?t+"&uiEmbed=1":t;var n=this.utilityService.parseUrl(t);if(this.wacOrigin=n&&n.origin,this.wacUrl=this.$sce.trustAsResourceUrl(t),this.sourceElement=document.getElementsByClassName("wopi-iframe")[0],this.sourceElement){var r=this.layout.bind(this);this.sourceElement.addEventListener("dom-ready",r),this.$window.addEventListener("resize",r),this.$scope.$on("$destroy",function(){e.sourceElement.removeEventListener("dom-ready",r),e.$window.removeEventListener("resize",r)})}},e.prototype.layout=function(){if(this.sourceElement&&this.$window.electronSafeIpc){this.uuid||(this.uuid=this.utilityService.generateUUID());var e=this.sourceElement.clientWidth,t=this.sourceElement.clientHeight;this.$window.electronSafeIpc.send(this.constants.events.desktopApp.webViewResize,{width:e,height:t,uuid:this.uuid})}},e.prototype._registerScenarioEnd=function(){var e=this,t=this.$location.host();if(!(!this.useElectronWebView&&(t.endsWith(this.constants.counters.skype.skypeDomain)||t.endsWith(this.constants.counters.microsoft.domain)))||this.isOneNote||this.isVisio||this.wacEdit)this._stopFullScreenScenario();else{var i=angular.element(this.$window);this._onPostMessageReceive&&(i.unbind("message",this._onPostMessageReceive),this._onPostMessageReceiveDestroyHandler()),this._onPostMessageReceive=function(t){return e._postMessageReceiveHandler(t)},i.on("message",this._onPostMessageReceive),this._onPostMessageReceiveDestroyHandler=this.$scope.$on("$destroy",function(){i.unbind("message",e._onPostMessageReceive)})}},e.prototype._postMessageReceiveHandler=function(e){var t=e.originalEvent||e;if(t&&t.origin&&t.origin===this.wacOrigin){var i=JSON.parse(t.data||"{}");i.MessageId&&i.MessageId.toLowerCase()==="App_LoadingStatus".toLowerCase()&&(this._stopFullScreenScenario("wac"),angular.element(this.$window).unbind("message",this._onPostMessageReceive),this._onPostMessageReceiveDestroyHandler(),this._onPostMessageReceive=null)}},e.prototype._stopFullScreenScenario=function(e){void 0===e&&(e=""),this.scenario&&this.scenario.stop({context:e})},e.prototype._ensureInitialFocusIsNotStolen=function(){var e=this;this.focusCounter=0;var t=angular.element(this.$window);this._onWindowBlur&&(t.unbind(this.constants.events.jQuery.blur,this._onWindowBlur),this._onWindowBlurDestroyHandler()),this._onWindowBlur=function(t){return e._onWindowBlurHandler(t)},t.on(this.constants.events.jQuery.blur,this._onWindowBlur),this._onWindowBlurDestroyHandler=this.$scope.$on("$destroy",function(){t.unbind(e.constants.events.jQuery.blur,e._onWindowBlur)})},e.prototype._onWindowBlurHandler=function(e){var t=this;this.focusCounter++;var i=this.isOneNote?2:1;this.focusCounter==i&&(angular.element(this.$window).unbind(this.constants.events.jQuery.blur,this._onWindowBlur),this._onWindowBlurDestroyHandler(),this._onWindowBlur=null),this.$timeout(function(){return angular.element(t.initialActiveElement).focus()},100,!1)},e}();angular.module("teamspace.fileOfficeViewer",["teamspace.settingsService","teamspace.filesUtilityService"]).component("fileOfficeViewer",{bindings:{type:"<",scenario:"<",wacEdit:"<",wacUrlSource:"<",ctx:"<",fileType:"<"},template:s,controller:n})},2518:function(e,t){e.exports='<div id="file-office-viewer" class="flex-fill">\n\n  <iframe ng-if="$ctrl.wacUrl && !($ctrl.useElectronWebView || $ctrl.useHwaWebView)" ng-src="{{$ctrl.wacUrl}}" ng-attr-sandbox="{{ ::$ctrl.isElectronApp ? \'allow-forms allow-popups allow-pointer-lock allow-same-origin allow-scripts\' : undefined }}" class="wopi-iframe flex-fill" frameborder="0" role="presentation" tabindex="-1" aria-hidden="true">\n  </iframe>\n\n  <webview ng-if="::$ctrl.useElectronWebView && !$ctrl.useHwaWebView" ng-src="{{$ctrl.wacUrl}}" class="wopi-iframe flex-fill" frameborder="0" role="presentation" tabindex="-1" aria-hidden="true" webpreferences="nativeWindowOpen=yes" allowpopups="">\n  </webview>\n\n  \x3c!-- TODO tac: use embedded-page-container instead once it supports url updates --\x3e\n  <x-ms-webview ng-if="::$ctrl.useHwaWebView" ng-src="{{$ctrl.wacUrl}}" class="wopi-iframe flex-fill" frameborder="0" role="presentation" tabindex="-1" aria-hidden="true">\n  </x-ms-webview>\n</div>\n'}},[2506]);